<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Import Barcode Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <title>IT Ticket Monitoring System</title>

    <style>
        /* =========================
           üé® THEME VARIABLES
        ========================== */
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --text: #1e293b;
            --muted: #64748b;
            --radius: 12px;
            --transition: all 0.25s ease;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --ok: #16a34a;
            --bad: #ef4444;
            --page-max-width: 1800px;
            --pagination-footer-height: 45px;
            /* New variable for footer height */

            /* üìè New: responsive table font sizes */
            --th-font: clamp(10px, 0.75vw, 13px);
            --td-font: clamp(11px, 0.85vw, 14px);
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            padding: 16px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2) fixed;
            color: var(--text);
            font-family: 'Segoe UI', Lexend, sans-serif;
            transition: var(--transition);
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .page {
            width: min(var(--page-max-width), 98vw);
            margin-inline: auto;
            position: relative;
            box-sizing: border-box;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius);
            padding: 18px 20px;
            text-align: center;
            transition: transform .15s, box-shadow .15s, background .15s;
        }

        .stat-title {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 12px;
            line-height: 1;
            font-weight: 800;
            color: var(--primary);
        }

        /* controls & pagination */
        .controls,
        .filters-row,
        .pagination {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 7px;
            justify-content: center;
            margin: 10px 0;
        }

        #searchBox,
        #statusFilter,
        #branchFilter,
        #dateFrom,
        #dateTo,
        #pageSize {
            padding: 10px 12px;
            min-width: 230px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: #fff;
            color: var(--text);
            transition: all 0.2s ease;
        }

        button {
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            color: #fff;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transition: transform .08s, box-shadow .15s, background .15s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:hover {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transform: translateY(-2px);
        }

        .pager-buttons {
            display: flex;
            gap: 6px;
        }

        .page-info {
            font-size: 14px;
            color: var(--muted);
        }

        /* table */
        .table-wrap {
            width: 100%;
            max-height: 70vh;
            overflow: auto;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            box-sizing: border-box;
        }

        table {
            width: 100%;
            background: transparent;
            table-layout: fixed;
        }

        thead {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        th,
        td {
            padding: 9px 10px;
            text-align: left;
            font-size: var(--td-font);
            line-height: 1.25;
            vertical-align: top;
            border-bottom: 1px solid rgba(0, 0, 0, 0.07);
            word-wrap: break-word;
            color: #080808 !important;
            word-break: break-word;
            box-sizing: border-box;

            /* Responsive Design Enhancements */
            @media (max-width: 1200px) {
                .page {
                    width: 99vw;
                    padding: 0 4px;
                }

                .table-wrap {
                    max-height: 60vh;
                }
            }

            @media (max-width: 1024px) {

                .filters-left,
                .stats-container {
                    flex-direction: column;
                    align-items: stretch;
                }

                .pagination-right {
                    flex-wrap: wrap;
                    justify-content: flex-start;
                }

                .table-wrap {
                    max-height: 50vh;
                }
            }

            @media (max-width: 900px) {
                .page {
                    width: 100vw;
                    padding: 0 2px;
                }

                .table-wrap {
                    max-height: 40vh;
                }
            }

            @media (max-width: 768px) {
                .header h1 {
                    font-size: 18px;
                }

                .header h2 {
                    font-size: 14px;
                }

                table th,
                table td {
                    font-size: 12px;
                    padding: 6px 8px;
                }

                #searchBox,
                #statusFilter,
                #branchFilter,
                #dateFrom,
                #dateTo {
                    min-width: 100% !important;
                }

                .table-wrap {
                    max-height: 30vh;
                }
            }

            @media (max-width: 600px) {

                .header,
                .header .header-title {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .header {
                    padding: 10px 2px;
                }

                .page {
                    padding: 0 1px;
                }

                .table-wrap {
                    max-height: 22vh;
                }

                .filters-top,
                .filters-bottom {
                    flex-direction: column;
                    gap: 6px;
                }
            }

            @media (max-width: 480px) {
                .nav-links {
                    gap: 10px;
                }

                .header h1 {
                    font-size: 16px;
                }

                .card {
                    padding: 10px;
                }

                .card-icon {
                    width: 48px;
                    height: 48px;
                    line-height: 48px;
                    font-size: 20px;
                }

                .submit-row {
                    flex-direction: column;
                }

                .submit-row .submit-btn {
                    width: 100%;
                }

                .table-wrap {
                    max-height: 15vh;
                }
            }
        }

        thead th {
            font-size: var(--th-font);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Let the "long" columns wrap naturally for readability */
        #dataTable th:nth-child(7),
        #dataTable td:nth-child(7),
        #dataTable th:nth-child(14),
        #dataTable td:nth-child(14),
        #dataTable th:nth-child(16),
        #dataTable td:nth-child(16) {
            white-space: normal;
        }

        /* Optional: keep tiny columns single-line and neat */
        #dataTable th:nth-child(1),
        #dataTable td:nth-child(1),
        #dataTable th:nth-child(8),
        #dataTable td:nth-child(8),
        #dataTable th:nth-child(9),
        #dataTable td:nth-child(9),
        #dataTable th:nth-child(12),
        #dataTable td:nth-child(12) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tbody tr:hover {
            background: #f0f2f5;
            color: #1f2937;
            /* Darker text on light hover */
            transition: background .25s;
        }

        .status-open {
            color: var(--bad);
            font-weight: 800;
            cursor: pointer;
        }

        .status-closed {
            color: var(--ok);
            font-weight: 800;
            cursor: pointer;
        }

        .closed-row {
            background: rgba(241, 245, 249, 0.7);
            color: #64748b;
        }

        /* New highlight for open tickets with specific statuses */
        .open-in-progress-row {
            background-color: #e0f2fe !important;
            /* A light blue color */
            color: #0c5464 !important;
        }

        /* row highlight animations */
        @keyframes pulseFadeNew {
            0% {
                background: #e6ffef;
                box-shadow: 0 0 0 0 rgba(34, 197, 94, .35)
            }

            50% {
                background: #fff;
                box-shadow: 0 0 0 12px rgba(34, 197, 94, 0)
            }

            100% {
                background: #fff;
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0)
            }
        }

        @keyframes pulseFadeClosed {
            0% {
                background: #fff1f1;
                box-shadow: 0 0 0 0 rgba(239, 68, 68, .35)
            }

            50% {
                background: #fff;
                box-shadow: 0 0 0 12px rgba(239, 68, 68, 0)
            }

            100% {
                background: #fff;
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0)
            }
        }

        .highlight-new {
            animation: pulseFadeNew 1.8s ease-out 1
        }

        .highlight-closed {
            animation: pulseFadeClosed 1.8s ease-out 1
        }

        /* modal shell */
        #statusModal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100010;
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 22px;
            border-radius: 14px;
            width: 750px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideDown .25s ease;
            cursor: grab;
            position: relative;
        }

        .modal-content:active {
            cursor: grabbing;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            margin: 0 0 14px;
            color: var(--primary);
            text-align: center;
            user-select: none;
        }

        /* info panel */
        /* This style is not used, but keeping for reference if needed */
        #modalTicketInfo {
            text-align: left;
            font-size: 16px;
            color: #000 !important;
            margin-bottom: 17px;
            line-height: 1.3;
            background: rgba(255, 255, 255, 0.5);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        /* Modal info grid layout */
        .modal-info-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 8px 12px;
            align-items: start;
        }

        .modal-info-label {
            font-weight: 700;
            color: var(--muted);
            text-align: right;
        }

        .modal-info-value {
            font-weight: 600;
            color: var(--text);
            text-align: left;
            word-break: break-word;
        }

        .modal-section {
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            padding-top: 16px;
            margin-top: 6px;
        }

        .modal-form {
            display: grid;
            grid-template-columns: 1fr;
            row-gap: 12px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field label {
            font-weight: 700;
        }

        #statusModal .field label {
            color: #000;
            text-align: left;
        }

        .field select,
        .field textarea,
        .field input[type="text"] {
            padding: 10px;
            width: 100%;
            border-radius: 10px;
            border: 1px solid #d1d5db;
            box-sizing: border-box;
            background: #fff;
            font-size: 15px;
            color: var(--text);
        }

        .field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .modal-close {
            background: #e2e8f0;
            color: #334155;
        }

        /* =========================
           üîî TOAST NOTIFICATIONS
        ========================== */
        .toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4000;
            min-width: 320px;
            max-width: 400px;
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            color: #fff;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transition: top 0.4s ease, opacity 0.4s ease;
        }

        .toast.show {
            top: 25px;
            opacity: 1;
        }

        .toast-icon {
            font-size: 22px;
        }

        .toast .title {
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .toast .meta {
            font-size: 12px;
            opacity: 0.8;
        }

        .toast button {
            background: transparent;
            color: #fff;
            box-shadow: none;
            padding: 0;
            margin-left: auto;
            font-size: 18px;
            opacity: 0.7;
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        @keyframes toastIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }

        /* Highlight active stat box */
        .stat-box.active {
            border: 2px solid #0b5ed7;
            box-shadow: 0 0 15px rgba(11, 94, 215, 0.6);
            transform: scale(1.03);
            transition: all 0.25s ease;
        }

        /* Smooth hover effect */
        .stat-box:hover {
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        #resetFiltersBtn {
            background: #6c757d;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background 0.2s ease;
        }

        #resetFiltersBtn:hover {
            background: #5a6268;
        }

        /* Smaller pagination buttons */
        .pager-btn {
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 6px;
            background: var(--primary);
            color: #fff;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pager-btn:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }

        /* Align pagination to right */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 6px;
            margin-bottom: 10px;
        }

        /* Filters Container */
        .filters-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .filters-top {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .filters-bottom {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-start;
        }

        #searchBox,
        #statusFilter,
        #branchFilter,
        #dateFrom,
        #dateTo {
            padding: 8px 10px;
            min-width: 180px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: var(--text);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 14px;
        }

        .filters-container button {
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: 0.2s;
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        /* Today's & Reset Buttons ‚Äî Same Size, Same Height */
        #todayBtn,
        #resetFiltersBtn {
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: background 0.2s ease, transform 0.1s ease;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #todayBtn {
            background-color: #0554bd;
            color: #fff;
        }

        #resetFiltersBtn {
            background-color: #64748b;
            color: #fff;
        }

        /* Hover Effects */
        #todayBtn:hover {
            background-color: #385edb;
            transform: scale(1.03);
        }

        #resetFiltersBtn:hover {
            background-color: #385edb;
            transform: scale(1.03);
        }

        /* Top Section Layout */
        .filters-pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 100;
            /* Ensure this container is above the table header */
        }

        .filters-pagination-container.dropdown-open {
            pointer-events: none;
            /* Keep this to prevent interaction when a dropdown is open over it */
        }

        /* Add smooth shadow when sticky */
        .filters-pagination-container.sticky {
            box-shadow: 0 4px 12px rgba(112, 91, 91, 0.15);
            transition: box-shadow 0.2s ease-in-out;
        }

        .pagination-bottom-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--glass-bg);
            border: 1px solid var(--border-glass);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            margin-top: 15px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.08);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .filters-left {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            flex: 1;
        }

        .pagination-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Page size label color */
        .page-size label {
            font-size: 12px;
            color: #475569;
        }

        #searchBox,
        #regionFilter,
        #branchFilter,
        #dateFilter {
            padding: 8px 12px;
            min-width: 140px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background: #fff;
            color: var(--text);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 14px;
        }

        #branchFilter {
            padding: 7px 10px;
            min-width: 140px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: var(--text);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .filters-left button,
        .pagination-right button {
            padding: 7px 10px;
            font-size: 12px;
            /* Standardized font size */
            font-weight: 700;
            /* Bolder text */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: 0.2s;
        }

        .reset-btn {
            background-color: #4a5568;
            /* Muted gray-blue */
            color: #fff;
        }

        .clear-btn {
            background-color: #c53030;
            /* Muted red */
            color: #fff;
        }

        .pager-btn {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            background: #1c47d4;
            /* A consistent blue for actions */
            color: #fff;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pager-btn:hover {
            background: #2c5282;
            /* Darker blue on hover */
            transform: scale(1.05);
        }

        .page-info {
            font-size: 13px;
            color: #475569;
            white-space: nowrap;
        }

        /* Make header background blue */
        .header {
            background: transparent;
            color: #fff;
            padding: 15px 0;
            text-align: center;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: none;
        }

        /* Make header text white */
        .header h1,
        .header h2 {
            color: #ffffff;
            margin: 0;
            padding: 2px 0;
        }

        .stat-box {
            flex: 1;
            min-width: 140px;
            background: var(--glass-bg);
            border: 1px solid var(--border-glass);
            padding: 18px;
            border-radius: 10px;
            box-shadow: var(--shadow-glass);
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }

        .stat-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 45px;
            font-weight: 700;
            color: #fff;
        }

        .stat-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 12px 16px;
            border-radius: 14px;
            text-align: center;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            user-select: none;
            /* Prevent text selection cursor on click */
        }

        .stat-box:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
        }

        /* Stat Titles */
        .stat-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 45px;
            font-weight: 700;
        }

        /* Individual Card Colors */
        #totalBox {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }

        #totalBox .stat-title {
            color: rgba(255, 255, 255, 0.8);
        }

        #openBox {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: #fff;
        }

        #closedBox .stat-title {
            color: rgba(255, 255, 255, 0.8);
        }

        #closedBox .stat-value {
            color: #ffffff;
        }

        #todayBox {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        */

        /* ===== SMOOTH TRANSITIONS ===== */
        body,
        .card,
        .stats-box,
        button,
        .btn,
        input,
        select,
        textarea,
        table,
        table thead th,
        table tbody tr,
        .modal-content,
        .modal-header,
        .modal-footer,
        .dropdown-menu {
            transition: background-color 0.3s ease-in-out,
                color 0.3s ease-in-out,
                box-shadow 0.3s ease-in-out,
                border-color 0.3s ease-in-out;
        }

        #closedBox {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff;
        }

        #totalBox .stat-value,
        #openBox .stat-value,
        #closedBox .stat-value,
        #todayBox .stat-value {
            color: #fff;
        }

        /* Ticket Status Buttons */
        .status-btn {
            display: inline-block;
            padding: 4px 10px;
            font-size: 13px;
            font-weight: 700;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .status-btn.closed {
            background: #22c55e;
            color: #fff;
        }

        .status-btn:hover {
            transform: scale(1.05);
        }

        .status-btn.open {
            display: inline-block;
            padding: 4px 10px;
            font-size: 13px;
            font-weight: 700;
            border-radius: 6px;
            text-align: center;
            background: #f97316;
            color: #fffefe !important;
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .status-btn.open:hover {
            transform: scale(1.05);
        }

        .status-closed-text {
            font-weight: 700;
            color: #0c8a3a;
        }

        .view-summary-btn {
            width: 34px;
            height: 34px;
            font-size: 14px;
            border-radius: 50%;
            background: linear-gradient(90deg, #2563eb, #1d4ed8);
            color: #fffdfd;
            border: none;
            cursor: pointer;
            transition: transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .view-summary-btn:hover {
            transform: scale(1.05);
        }

        /* === NEW: Print Button in Summary Modal === */
        .print-summary-btn {
            background: #198754;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* === NEW: Redesigned Ticket Summary Modal === */
        #summaryModal .modal-content {
            max-width: 850px;
            /* Wider for two columns */
        }

        #summaryModal .modal-header h2 {
            color: var(--primary);
            font-weight: 700;
        }

        #summaryModal .modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            padding: 20px;
        }

        .summary-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .summary-section h3 {
            font-size: 16px;
            color: var(--muted);
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
            margin: 0 0 8px 0;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
        }

        .summary-value {
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            word-break: break-word;
        }

        .summary-value.highlight {
            font-weight: 700;
            color: var(--primary);
            background: #eef2ff;
            border-color: #c7d2fe;
        }

        #summaryModal .asset-code-barcode {
            font-size: 40px;
            /* Make barcode larger */
        }

        /* Iframe Profile Modal */
        .iframe-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(5px);
            z-index: 100100;
            justify-content: center;
            align-items: center;
            padding: 20px;

            .iframe-modal-content {
                background: var(--surface, #fff);
                width: 96%;
                max-width: 1200px;
                height: 100vh;
                border-radius: 16px;
                overflow: hidden;
                /* This is correct */
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
                display: flex;
                flex-direction: column;
                position: relative;
                animation: fadeIn 0.4s ease;
            }

            .iframe-modal-content iframe {
                flex-grow: 1;
                border: none;
                width: 100%;
                height: 100%;
            }

            /* Summary Modal Specifics */
            #summaryModal .modal-section {
                display: grid;
                grid-template-columns: 180px 1fr;
                gap: 10px;
                align-items: start;
            }

            #summaryModal .modal-section .modal-label,
            #summaryModal .modal-section .modal-value {
                text-align: left;
            }

            #summaryDetails p {
                margin: 6px 0;
            }

            .repair-status {
                display: inline-block;
                padding: 4px 10px;
                font-size: 13px;
                font-weight: 700;
                border-radius: 6px;
                text-align: center;
                color: #fff;
                user-select: none;
            }

            .repair-status.in-progress,
            .repair-status.pending,
            .repair-status.on-hold,
            .repair-status.completed,
            .repair-status.not-fixed {
                display: inline-block;
                padding: 4px 10px;
                font-size: 13px;
                font-weight: 700;
                border-radius: 6px;
                text-align: center;
                cursor: pointer;
                transition: background 0.2s ease, transform 0.1s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                user-select: none;
                color: #fff;
            }

            .repair-status.in-progress {
                background: #f59e0b;
            }

            .repair-status.pending {
                background: #3b82f6;
            }

            .repair-status.on-hold {
                background: #17a2b8;
            }

            .repair-status.completed {
                background: #22c55e;
            }

            .repair-status.not-fixed {
                background: #dc3545;
            }

            .repair-status.failed {
                background: #ef4444;
            }

            /* üì± Responsive Enhancements */
            @media (max-width: 1024px) {
                .filters-left {
                    flex-direction: column;
                    align-items: stretch;
                }

                .pagination-right {
                    flex-wrap: wrap;
                    justify-content: flex-start;
                }

                .stats-container {
                    flex-direction: column;
                    align-items: stretch;
                }
            }

            @media (max-width: 768px) {
                .header h1 {
                    font-size: 18px;
                }

                .header h2 {
                    font-size: 14px;
                }

                table th,
                table td {
                    font-size: 12px;
                    padding: 6px 8px;
                }

                #searchBox,
                #statusFilter,
                #branchFilter,
                #dateFrom,
                #dateTo {
                    min-width: 100% !important;
                }
            }

            @media (max-width: 480px) {
                .filters-pagination-container {
                    flex-direction: column;
                    align-items: stretch;
                    gap: 10px;
                }

                .stats-container {
                    gap: 12px;
                }

                .stat-box {
                    min-width: unset;
                    width: 100%;
                }

                .view-summary-btn {
                    padding: 6px 8px;
                    font-size: 11px;
                }

                .repair-status {
                    padding: 3px 6px;
                    font-size: 11px;
                }
            }

            /* üîî Notification styles */
            #notificationContainer {
                position: fixed;
                top: 80px;
                left: 20px;
                display: flex;
                flex-direction: column;
                gap: 12px;
                z-index: 9999;
            }

            .notification {
                padding: 14px 18px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
                font-size: 14px;
                animation: slideIn 0.4s ease, fadeOut 0.9s ease 4.5s forwards;
                color: #fff;
                min-width: 280px;
            }

            .notification strong {
                display: block;
                font-size: 15px;
                margin-bottom: 4px;
            }

            /* Types */
            .notification.success {
                background: #22c55e;
            }

            .notification.error {
                background: #ef4444;
            }

            .notification.info {
                background: #3b82f6;
            }

            .notification .close-btn {
                position: absolute;
                top: 6px;
                right: 8px;
                background: transparent;
                border: none;
                color: #fff;
                font-size: 16px;
                cursor: pointer;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateX(-100%);
                }

                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            /* Auto fade after 5s */
            @keyframes fadeOut {
                to {
                    opacity: 0;
                    transform: translateX(-100%);
                }
            }

            @keyframes fadeInScale {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }

                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

        }

        /* Removed empty ruleset */
        #summaryModal .modal-content {
            background: #fff;
            color: #222;
            border-radius: 22px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.22);
            width: 100%;
            max-width: 750px;
            /* New flex layout for sticky footer */
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            overflow: hidden;
        }

        /* Labels and values */
        #summaryModal .modal-label {
            font-weight: 600;
            display: inline-block;
            /* Reduced min-width for tighter fit */
            min-width: 160px;
            color: #8094b1;
            font-size: 15px;
        }

        #summaryModal .modal-value {
            background: #e0e7ef;
            border-radius: 8px;
            padding: 4px 10px;
            /* Reduced padding */
            font-size: 15px;
            color: #222;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 2px;
            word-break: break-word;
            white-space: normal;
            max-width: 100%;
        }

        /* Modal heading */
        #summaryModal h2 {
            margin-top: 0;
            color: var(--primary, #0b5ed7);
            text-align: center;
            font-size: 1.3rem;
        }

        /* Section spacing */
        #summaryModal .modal-section {
            margin: 6px 0;
            /* Reduced vertical margin */
            border-bottom: 1px solid var(--border, #eee);
            padding-bottom: 4px;
            /* Reduced bottom padding */
        }

        /* Button */
        #summaryModal .modal-footer button {
            background: #0b5ed7;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        #summaryModal .modal-footer button:hover {
            background: #4d87dd;
        }

        /* === NEW SUMMARY MODAL STYLES === */
        #summaryModal {
            display: none;
            /* Hidden by default */
            position: fixed;
            inset: 0;
            /* background: rgba(0, 0, 0, 0.65); */
            /* Use glassmorphic background from .iframe-modal */
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            z-index: 100100;
            display: flex;
            /* Use flex for centering */
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #summaryModal .modal-header {
            padding: 14px 20px;
            /* Reduced padding */
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #summaryModal .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-600);
        }

        #summaryModal .modal-body {
            padding: 20px;
            /* Reduced padding */
            overflow-y: auto;
            flex-grow: 1;
            /* Allows body to take up available space and scroll */
            display: flex;
            flex-direction: column;
            gap: 12px;
            /* Reduced gap between sections */
        }

        #summaryModal .summary-section {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 12px;
            /* Reduced padding */
            text-align: left;
        }

        /* === NEW: Photo Thumbnail Styles === */
        .photo-thumbnail {
            width: 40px;
            height: 40px;
            object-fit: cover;
            /* Ensures the image fills the circle */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.5);
            /* White border with some transparency */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            /* Subtle shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .photo-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 10;
            position: relative;
        }

        .modal-value.highlight {
            font-weight: bold;
            color: #1a73e8;
            background: rgba(26, 115, 232, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }

        .repair-status.closed {
            color: #fff;
            background: #40d340;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
        }

        .repair-status.open {
            color: #fff;
            background: #e4402a;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
        }

        .repair-status.completed {
            color: #fff;
            background: #28a745;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: bold;
        }

        /* Barcode font style for Asset Code */
        .asset-code-barcode {
            font-family: 'Libre Barcode 39 Text', cursive;
            font-size: 35px;
            line-height: 1.1;
        }

        /* ===== Balanced Table Layout ===== */
        #dataTable {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }

        /* Compact columns (short data) */
        #dataTable th:nth-child(1),
        #dataTable td:nth-child(1) {
            width: 140px;
        }

        #dataTable th:nth-child(2),
        #dataTable td:nth-child(2) {
            width: 120px;
            text-align: center;
        }

        /*IT Personel */
        #dataTable th:nth-child(8),
        #dataTable td:nth-child(8) {
            width: 150px;
            text-align: center;
        }

        /*Repair Completed Time */
        #dataTable th:nth-child(9),
        #dataTable td:nth-child(9) {
            width: 120px;
            text-align: center;
        }

        #dataTable th:nth-child(12),
        #dataTable td:nth-child(12) {
            width: 130px;
            text-align: center;
        }

        #dataTable th:nth-child(13),
        #dataTable td:nth-child(13) {
            width: 110px;
            text-align: center;
        }

        /* Wider text-heavy columns */
        #dataTable th:nth-child(7),
        #dataTable td:nth-child(7) {
            width: 200px;
            white-space: normal;
            word-wrap: break-word;
        }

        #dataTable th:nth-child(14),
        #dataTable td:nth-child(14),
        #dataTable th:nth-child(16),
        #dataTable td:nth-child(16) {
            width: 280px;
            white-space: normal;
            word-wrap: break-word;
        }

        /* Prevent wrapping on the Repair Status column */
        #dataTable th:nth-child(10),
        #dataTable td:nth-child(10) {
            white-space: nowrap;
            width: 130px;
            text-align: center;
        }

        /* Adjust width for Photo column */
        #dataTable th:nth-child(6),
        #dataTable td:nth-child(6) {
            width: 80px;
            text-align: center;
        }

        /* Adjust width for Ticket Status column */
        #dataTable th:nth-child(7),
        #dataTable td:nth-child(7) {
            width: 100px;
            text-align: center;
        }

        /* Adjust width for Region and Reported By columns */
        #dataTable th:nth-child(3),
        #dataTable td:nth-child(3) {
            width: 160px;
        }

        #dataTable th:nth-child(4),
        #dataTable td:nth-child(4) {
            width: 180px;
        }

        /* Adjust width for View Summary icon column */
        #dataTable th:nth-child(11),
        #dataTable td:nth-child(11) {
            width: 80px;
            text-align: center;
        }

        /* Default for other columns */
        #dataTable th,
        #dataTable td {
            padding: 8px 10px;
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Allow horizontal scroll if too wide */
        .table-wrap {
            width: 100%;
            overflow-x: auto;
        }

        /* blinking animation for new tickets*/
        @keyframes blinkNew {

            0%,
            100% {
                background-color: #8fc3f3;
                color: #713f12 !important;
            }

            50% {
                background-color: #8fc3f3;
                color: #713f12 !important;
            }
        }

        .blink-new {
            animation: blinkNew 2s ease-in-out 3;
        }

        /* Spinner Overlay */
        .spinner-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            z-index: 100020;
            align-items: center;
            justify-content: center;
            transition: opacity 0.22s ease;
        }

        .spinner-overlay.show {
            display: flex;
            opacity: 1;
        }

        .spinner-box {
            width: 92px;
            height: 92px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(37, 99, 235, 0.12));
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }

        .spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 6px solid rgba(255, 255, 255, 0.18);
            border-top-color: #fff;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .notification-bell {
            position: relative;
            z-index: 100;
            font-size: 24px;
            cursor: pointer;
            color: #fff;
            display: inline-block;
            transition: transform 0.2s ease;
        }

        .notification-bell:hover {
            transform: scale(1.15);
        }

        #notificationDropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 30px;
            margin-top: 18px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        #notificationCount {
            position: absolute;
            top: 6px;
            right: 10px;
            background: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        .small-icon-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff !important;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        /* Header wrapper - Blue design from unti.html */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(230, 247, 251, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            gap: 20px;
        }

        .header-left-top {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left-top img {
            height: 58px;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .header-title .system-name {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .header-title .system-sub {
            font-size: 18px;
            color: var(--muted);
        }

        .welcome-box {
            margin-top: 10px;
            padding: 8px 12px;
            background: #ffffff22;
            border: 1px solid #ffffff44;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            text-align: left;
            max-width: 100%;
            font-size: 18px;
            font-weight: 500;
            color: var(--muted);
            line-height: 1.2;
        }

        .welcome-user .welcome,
        .welcome-user .username {
            display: block;
            font-size: 20px;
            font-weight: 900;
            color: var(--text);
            line-height: 1.3;
        }

        .welcome-box a {
            color: var(--primary);
            text-decoration: none;
            transition: opacity 0.2s ease;
            font-size: 16px;
        }

        .welcome-box a:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: flex-start;
        }

        .main-links {
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 4px;
        }

        /* New 3D Nav Link Button Style */
        .nav-link-btn {
            background-color: #fff;
            color: var(--primary) !important;
            text-decoration: none !important;
            padding: 10px 18px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 13px;
            border: none;
            border-bottom: 4px solid rgba(0, 0, 0, 0.1);
            /* Darker bottom border for 3D effect */
            transition: all 0.15s ease-in-out;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .nav-link-btn:hover {
            background-color: #eef2ff;
            /* Lighter blue background on hover */
            transform: translateY(-2px);
            color: var(--primary) !important;
            /* Keep the text color the same for readability */
        }

        .nav-link-btn:active {
            transform: translateY(1px);
            border-bottom-width: 2px;
        }

        /* Smaller Logout Button */
        #logoutBtn {
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 600;
            background-color: #ef4444;
            /* Red color for logout */
            color: #fff !important;
            border-bottom: 4px solid rgba(127, 29, 29, 0.4);
        }

        #logoutBtn:hover {
            background-color: #dc2626;
        }

        /* Profile Pic and Username Hover Effects */
        #userProfilePic {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #userProfilePic:hover {
            transform: scale(1.05);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.5);
        }

        #userGreeting:hover {
            color: var(--primary) !important;
            /* Gold hover color */
        }

        .iframe-modal.chat-window {
            /* Override default modal positioning so the chat window sits above other floating controls */
            inset: auto;
            position: fixed;
            display: none;
            /* hidden by default */
            justify-content: unset;
            align-items: unset;
            /* Anchor directly above the chat icon (uses chat icon CSS variables)
                    Add --chat-modal-offset-y to nudge the modal up (positive = move up) */
            bottom: calc(var(--chat-icon-bottom, 25px) + var(--chat-icon-height, 60px) + var(--chat-modal-offset-y, 12px));
            /* position modal to the left of the chat icon so icon remains visible
                    we subtract a small offset (--chat-modal-offset-x) to nudge modal left */
            right: calc(var(--chat-icon-right, 25px) + var(--chat-icon-width, 60px) - var(--chat-modal-offset-x, 16px));
            /* Remove overlay styles but keep visual separation */
            background: transparent;
            border: none;
            backdrop-filter: none;
            padding: 0;
            /* Fixed size (responsive via max-*) */
            width: 360px;
            height: 500px;
            max-width: 90vw;
            max-height: 70vh;
            z-index: 100200;
            /* ensure it appears above other bottom-right controls */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
            border-radius: 12px;
        }

        /* NEW: Chat notification badge */
        #chatNotificationCount {
            position: absolute;
            top: 0px;
            right: 0px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            min-width: 22px;
            text-align: center;
            line-height: 18px;
        }

        /* === NEW: Chat Icon Hover Area === */
        #chatIconContainer {
            position: fixed;
            bottom: calc(var(--pagination-footer-height) + 5px);
            right: 0;
            width: 80px;
            height: 80px;
            z-index: 100100;
            overflow: hidden;
            /* Hide the part of the icon that is outside */
        }

        /* === NEW: Chat Hint Tab === */
        .chat-hint {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 40px;
            background: rgba(109, 40, 217, 0.5);
            border-radius: 8px 0 0 8px;
            box-shadow: -2px 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        /* === NEW: Chat Icon 3D Style === */
        #chatIcon {
            position: absolute;
            bottom: 10px;
            right: 10px;
            cursor: pointer;
            background: #6d28d9;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            /* 3D Effect */
            border-bottom: 5px solid #4c1d95;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
            transform: translateX(80px);
            /* Start off-screen to the right */
        }

        #chatIconContainer:hover #chatIcon {
            transform: translateX(0);
            /* Slide into view */
            pointer-events: auto;
        }

        #chatIcon:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.4);
        }

        #chatIcon:active {
            transform: translateY(1px);
            border-bottom-width: 2px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        /* === NEW: Manual Icon Animation === */
        @keyframes pulseManualIcon {

            0%,
            100% {
                transform: translateY(0) scale(1);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            50% {
                transform: translateY(-5px) scale(1.1);
                box-shadow: 0 10px 25px rgba(109, 40, 217, 0.4);
            }
        }


        /* === NEW: Manual Icon Style === */
        #manualIcon {
            position: fixed;
            bottom: calc(var(--pagination-footer-height) + 15px);
            /* Position above footer */
            left: 25px;
            /* Position it on the bottom-left */
            z-index: 100090;
            /* Keep it below the chat icon's z-index */
            cursor: pointer;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: pulseManualIcon 2s infinite ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            /* Ensures the image stays within the circle */
        }

        #manualIcon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            /* Horizontally flip the image */
        }

        #manualIcon:hover {
            transform: translateY(-3px) scale(1.05);
            animation-play-state: paused;
            /* Pause animation on hover */
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.35);
        }

        /* === NEW: Manual Icon Notification Bubble === */
        #manualNotification {
            position: fixed;
            bottom: calc(var(--pagination-footer-height) + 30px);
            /* Position above the icon */
            left: 85px;
            /* Position to the right of the icon */
            background: linear-gradient(135deg, #6d28d9, #db2777);
            color: #fff;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 100091;
            /* Above the icon */
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header-container" style="display: flex; justify-content: space-between; align-items: center;">
        <!-- Left Section -->
        <div class="header-left"
            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; align-items: center;">
            <div class="stat-box stat-total" id="totalBox">
                <div class="stat-title">Total Tickets</div>
                <div id="totalTickets" class="stat-value">0</div>
            </div>
            <div class="stat-box stat-open" id="openBox">
                <div class="stat-title">Open Tickets</div>
                <div id="openTickets" class="stat-value">0</div>
            </div>
            <div class="stat-box stat-closed" id="closedBox">
                <div class="stat-title">Closed Tickets</div>
                <div id="closedTickets" class="stat-value">0</div>
            </div>
            <div class="stat-box stat-today" id="todayBox">
                <div class="stat-title">Today's Tickets</div>
                <div id="todayTickets" class="stat-value">0</div>
            </div>
        </div>

        <!-- Right Section -->
        <div class="header-right" style="display: flex; align-items: center; gap: 16px;">
            <div class="user-profile-container">
                <div class="user-info"
                    style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px; text-align: right;">
                    <img id="userProfilePic" src="https://imgur.com/fM3Hfju.png" alt="User"
                        style="width: 70px; height: 70px; border-radius: 50%; border: 2px solid #ffffff55; object-fit: cover; cursor: pointer;"
                        onclick="openProfileIframe()">
                    <div>
                        <a href="javascript:void(0)" id="userGreeting" onclick="openProfileIframe()"
                            style="text-decoration: none; color: var(--text); font-weight: 700; font-size: 16px; display: block;"></a>
                        <span id="userTypeDisplay"
                            style="font-size: 13px; color: var(--muted); font-weight: 500;"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Filters + Pagination -->
    <div class="filters-pagination-container">
        <div class="main-links">
            <a href="javascript:void(0)" onclick="openStatisticsModal()" class="nav-link-btn">Show
                Statistics</a>
            <a href="javascript:void(0)" onclick="openSubmitTicketModal()" class="nav-link-btn">Submit
                Ticket</a>
            <a href="javascript:void(0)" onclick="openItPersonnelModal()" class="nav-link-btn">IT Personnel</a>
            <a href="#" onclick="logout()" id="logoutBtn" class="nav-link-btn">Logout</a>

            <!-- Notification Bell -->
            <div class="notification-bell" style="position:relative; cursor:pointer; font-size: 20px;">
                üîî
                <span id="notificationCount"
                    style="position:absolute; top:-8px; right:-8px; background:red; color:white; font-size:12px; padding:2px 6px; border-radius:50%; display:none;">
                </span>
                <!-- Dropdown -->
                <div id="notificationDropdown"
                    style="display:none; position:absolute; right:0; top:30px; width:300px; max-height:400px; overflow-y:auto; background:var(--surface); border:1px solid #ccc; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.2);">
                    <ul id="notificationList" style="list-style:none; margin:0; padding:10px;"></ul>
                </div>
            </div>

        </div>

        <div class="filter-buttons">
            <input id="searchBox" type="text" placeholder="üîç Search tickets..." />
            <select id="statusFilter" style="display: none;">
                <option value="all">All Status</option>
                <option value="open">Open Tickets</option>
                <option value="closed">Closed Tickets</option>
            </select>
            <select id="regionFilter">
                <option value="all">All Regions</option>
                <!-- Regions will be populated by JS -->
            </select>
            <select id="branchFilter">
                <option value="all">All Branches</option>
            </select>
            <input type="date" id="dateFilter" />
            <button id="todayBtn">Today's</button>
            <button id="resetFiltersBtn" class="reset-btn">‚ôª Reset</button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
        <table id="dataTable" style="display:none;">
            <thead>
                <tr>
                    <th title="Unique ID for each repair ticket">Ticket#</th>
                    <th title="Date and time when the ticket was submitted">DateSubmitted</th>
                    <th title="Region where the issue was reported">Region</th>
                    <th title="Branch and person who reported the issue">Reported by</th>
                    <th title="Device and problem description">Issue Details</th>
                    <th title="Uploaded photo of the issue">Photo</th>
                    <th title="Current ticket status">TicketStatus</th>
                    <th title="Assigned IT personnel">I.T.Person</th>
                    <th title="Time when IT get the ticket">RepairComplete</th>
                    <th title="Latest repair status and time">RepairStatus</th>
                    <th title="View ticket summary">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- NEW: Sticky Bottom Pagination -->
    <div class="pagination-bottom-container" id="paginationBottom">
        <div class="page-info" id="pageInfo">Page 1 of 1 ‚Ä¢ Showing 0‚Äì0 of 0</div>
        <div class="pager-buttons">
            <button id="firstPageBtn" class="pager-btn">‚èÆ</button>
            <button id="prevPageBtn" class="pager-btn">‚óÄ</button>
            <button id="nextPageBtn" class="pager-btn">‚ñ∂</button>
            <button id="lastPageBtn" class="pager-btn">‚è≠</button>
        </div>
        <div class="page-size">
            <label for="pageSize">Per page:</label>
            <select id="pageSize" style="padding: 4px 6px; font-size: 11px; border-radius: 6px;">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>


    <!-- Modal -->
    <div id="statusModal">
        <div class="modal-content">
            <h3>Update Ticket Status</h3>

            <div id="modalTicketInfo">
                <div class="modal-info-grid">
                    <div class="modal-info-label">Ticket #:</div>
                    <div class="modal-info-value" id="modalTicketNumber"></div>

                    <div class="modal-info-label">Asset Code:</div>
                    <div class="modal-info-value" id="modalAssetCode"></div>

                    <div class="modal-info-label">Branch:</div>
                    <div class="modal-info-value" id="modalBranch"></div>

                    <div class="modal-info-label">Device:</div>
                    <div class="modal-info-value" id="modalDevice"></div>

                    <div class="modal-info-label">Problem:</div>
                    <div class="modal-info-value" id="modalProblem"></div>

                    <div class="modal-info-label">Ticket Status:</div>
                    <div class="modal-info-value" id="modalTicketStatus"></div>

                    <div class="modal-info-label">Repair Status:</div>
                    <div class="modal-info-value" id="modalRepairStatusText"></div>
                </div>
            </div>

            <input type="hidden" id="modalTicketId" />

            <!-- perfectly aligned form -->
            <div class="modal-section">
                <div class="modal-form">
                    <div class="field">
                        <label for="modalPersonnel">Assign to IT Personnel <span style="color:#ff3b3b">*</span></label>
                        <select id="modalPersonnel">
                            <option value="">-- Select Personnel --</option>
                        </select>
                        <small id="assignedInfo" style="color:#28a745; display:none; font-weight:bold;"></small>
                    </div>

                    <div class="field">
                        <label for="modalStatus">Repair Status <span style="color:#ff3b3b">*</span></label>
                        <select id="modalStatus">
                            <option value="pending">Pending</option>
                            <option value="in-progress">In-Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On-Hold</option>
                            <option value="not-fixed">Not-Fixed</option>
                        </select>
                    </div>

                    <div class="field">
                        <label for="modalParts">Required Parts (optional)</label>
                        <input type="text" id="modalParts" placeholder="e.g., SSD 240GB, RAM 8GB" />
                    </div>

                    <div class="field">
                        <label for="modalRemarks">Remarks (optional)</label>
                        <textarea id="modalRemarks" placeholder="Add remarks..."></textarea>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button onclick="confirmUpdate()">‚úÖ Update Status</button>
                <button id="transferBtn" class="soft" onclick="toggleTransferPanel()">‚Ü™Ô∏è Transfer Ticket</button>
                <button class="modal-close" onclick="closeModal()">‚ùå Close</button>
            </div>

            <!-- Hidden Transfer Panel -->
            <div id="transferPanel"
                style="display:none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #eef2f7;">
                <h4>Transfer Ticket to another Region</h4>
                <div class="modal-form" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
                    <div class="field">
                        <label for="transferRegionSelect">New Region</label>
                        <select id="transferRegionSelect" onchange="populateTransferBranches()">
                            <option value="">-- Select New Region --</option>
                            <option>Batangas Operation</option>
                            <option>Laguna Operation</option>
                            <option>Cavite Operation</option>
                            <option>CARMONA Operation</option>
                            <option>Manila Operation</option>
                            <option>Bulacan Operation</option>
                            <option>NCR North Operation</option>
                            <option>NCR South Operation</option>
                            <option>Quezon City Operation</option>
                            <option>CAMANA Operation</option>
                            <option>Pampanga Operation</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="transferBranchSelect">New Branch</label>
                        <select id="transferBranchSelect">
                            <option value="">-- Select Branch --</option>
                        </select>
                    </div>
                </div>
                <button onclick="transferTicket()" style="margin-top: 10px; background: #f59e0b; width: 100%;">Confirm
                    Transfer</button>
            </div>
        </div>
    </div>

    <!-- Spinner Overlay -->
    <div id="spinnerOverlay" class="spinner-overlay" aria-hidden="true">
        <div class="spinner-box">
            <div class="spinner" aria-hidden="true"></div>
        </div>
    </div>

    <!-- Sounds -->
    <audio id="soundNew" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <audio id="soundClosed" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
        preload="auto"></audio>

    <!-- Toast Container -->
    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <!-- Ticket Summary Modal -->
    <div id="summaryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ticket Summary</h2>
                <button class="modal-close" onclick="closeSummaryModal()"
                    style="padding: 4px 10px; font-size: 14px;">&times;</button>
            </div>
            <div class="modal-body" id="summaryModalBody">
                <!-- Content will be injected by JS -->
            </div>
            <div class="modal-footer" style="text-align: right; padding: 12px 20px; border-top: 1px solid #eee;">
                <button id="printSummaryBtn" class="print-summary-btn">
                    <i class="fas fa-print"></i> <span>Print Report</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Iframe Modal -->
    <div id="profileIframeModal" class="iframe-modal">
        <div class="iframe-modal-content">
            <span class="close" onclick="closeProfileIframe()"
                style="position: absolute; top: 15px; right: 15px; color: #111; background: #fff; border-radius: 50%; width: 40px; height: 40px; line-height: 40px; text-align: center; font-size: 28px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 10;">&times;</span>
            <iframe id="profileFrame" src=""></iframe>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statisticsModal" style="
    display:none;
    position:fixed;
    inset:0;
            background:rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
    z-index:5000;
    justify-content:center;
    align-items:center;
">
        <div style="
        background:rgba(255, 255, 255, 0.85); border: 1px solid rgba(255, 255, 255, 0.3);
        width:96%;
        max-width:1200px;
        height:97vh;
        border-radius:12px;
        overflow:hidden;
        box-shadow:0 10px 25px rgba(0,0,0,0.4);
        display:flex;
        flex-direction:column;
    ">
            <div
                style="padding:10px; background:rgba(255, 255, 255, 0.5); color:var(--text); border-bottom: 1px solid rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center;">
                <span>üìä Ticket Statistics</span>
                <button onclick="closeStatisticsModal()"
                    style="background:transparent; border:none; color:#333; font-size: 28px; padding:0 12px; cursor:pointer; line-height: 1;">&times;</button>
            </div>
            <iframe id="statisticsFrame" src="" style="flex:1; border:none; width:100%; height:100vh;"></iframe>
        </div>
    </div>

    <!-- IT Personnel Modal -->
    <div id="itPersonnelModal" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(8px);
    z-index:5000;
    justify-content:center;
    align-items:center;
">
        <div style="
        background:rgba(255, 255, 255, 0.85); border: 1px solid rgba(255, 255, 255, 0.3);
        width:96%;
        max-width:1400px; /* Wider for personnel grid */
        height:97vh;
        border-radius:12px;
        overflow:hidden;
        box-shadow:0 10px 25px rgba(0,0,0,0.4);
        display:flex;
        flex-direction:column;
    ">
            <div
                style="padding:10px; background:rgba(255, 255, 255, 0.5); color:var(--text); border-bottom: 1px solid rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center;">
                <span>üßë‚Äçüíª IT Personnel</span>
                <button onclick="closeItPersonnelModal()"
                    style="background:transparent; border:none; color:#333; font-size: 28px; padding:0 12px; cursor:pointer; line-height: 1;">&times;</button>
            </div>
            <iframe id="itPersonnelFrame" src="" style="flex:1; border:none; width:100%; height:100%;"></iframe>
        </div>
    </div>

    <!-- Submit Ticket Iframe Modal -->
    <div id="submitTicketModal" class="iframe-modal">
        <div class="iframe-modal-content" style="max-width: 900px; height: 90vh;">
            <div
                style="padding:10px; background:rgba(255, 255, 255, 0.5); color:var(--text); border-bottom: 1px solid rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center;">
                <span>üìù Submit New Ticket</span>
                <button onclick="closeSubmitTicketModal()"
                    style="background:transparent; border:none; color:#333; font-size: 28px; padding:0 12px; cursor:pointer; line-height: 1;">&times;</button>
            </div>
            <iframe id="submitTicketFrame" src="" style="flex:1; border:none; width:100%; height:100%;"></iframe>
        </div>
    </div>

    <!-- NEW: Image Preview Modal -->
    <div id="imagePreviewModal" class="iframe-modal">
        <div class="iframe-modal-content"
            style="max-width: 900px; max-height: 900px; background: transparent; box-shadow: none; overflow: visible;">
            <span class="close" onclick="closeImagePreviewModal()"
                style="position: absolute; top: -15px; right: -15px; color: #111; background: #fff; border-radius: 50%; width: 40px; height: 40px; line-height: 40px; text-align: center; font-size: 28px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 10;">&times;</span>
            <img id="previewImage" src=""
                style="width: 100%; height: 100%; object-fit: contain; border-radius: 16px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
        </div>
    </div>


    <!-- NEW: Print Iframe Modal -->
    <div id="printIframeModal" class="iframe-modal">
        <div class="iframe-modal-content" style="max-width: 1200px;">
            <div
                style="padding:10px; background:rgba(255, 255, 255, 0.5); color:var(--text); border-bottom: 1px solid rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center;">
                <span>üñ®Ô∏è Print Report</span>
                <button onclick="closePrintIframeModal()"
                    style="background:#d9534f; border:none; color:#fff; padding:6px 12px; border-radius:6px; cursor:pointer;">Close</button>
            </div>
            <iframe id="printFrame" src="" style="flex:1; border:none; width:100%; height:100%;"></iframe>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <!-- Manual Icon -->
    <a id="manualIcon" href="IT Manual.html" target="_blank" title="Open IT Manual">
        <img src="https://i.imgur.com/fM3Hfju.png" alt="User Manual">
    </a>

    <!-- NEW: Manual Icon Notification -->
    <div id="manualNotification">Click Me for IT Manual</div>


    <!-- Chat Icon -->
    <div id="chatIconContainer">
        <div class="chat-hint"></div>
        <div id="chatIcon" onclick="toggleChatIframeModal()">
            <i class="fas fa-comments"></i>
            <span id="chatNotificationCount" style="display: none;"></span>
        </div>
    </div>

    <!-- Chat Iframe Modal -->
    <div id="chatIframeModal" class="iframe-modal chat-window">
        <div class="iframe-modal-content" style="max-width: 500px; height: 60vh;">
            <div style="padding:10px; background:#6d28d9; color:#fff; display:flex; justify-content:space-between; align-items:center; border-radius: 12px 12px 0 0;"
                id="chatModalHeader" class="glass-header">
                <span id="chatModalTitle">üí¨ IT Staff Chat</span>
                <button onclick="closeChatIframeModal()"
                    style="background:transparent; border:none; color:#fff; font-size: 24px; padding:0 12px; cursor:pointer; line-height: 1;">&times;</button>
            </div>
            <iframe id="chatFrame" src="" style="flex:1; border:none; width:100%; height:100%;"></iframe>
        </div>
    </div>
    <script>
        // Region ‚Üí Branch mapping (from Ticket Request form)
        const regionBranches = {
            "Batangas Operation": ["Balayan Branch", "Batangas 1 Branch", "Batangas 2 Branch", "Bauan Branch", "Lemery Branch", "Lipa 1 Branch", "Lipa 2 Branch", "Malvar Branch", "Nasugbu Branch", "Rosario Branch", "San Jose Batangas Branch", "San Juan Batangas Branch", "Sto Tomas Branch", "Talisay Branch", "Batangas DC", "Batangas Head Office"],
            "Laguna Operation": ["Bay Branch", "Cabuyao Branch", "Calamba 01 Branch", "Calamba 02 Branch", "Famy Branch", "Liliw Branch", "San Pablo Branch", "San Pedro Branch", "Sta Cruz Branch", "Sta Rosa Branch", "Victoria Branch", "Laguna DC", "Laguna Head Office"],
            "Cavite Operation": ["Alfonso Branch", "Bacoor 1 Branch", "Bacoor 2 Branch", "General Trias Branch", "Imus Branch", "Indang Branch", "Kawit Branch", "Naic Branch", "Silang Branch", "Tagaytay Branch", "Tanza Branch", "Trece Martires Branch", "Dasma 001 Branch", "Dasma 002 Branch", "Cavite Head Office"],
            "CARMONA Operation": ["Cavite DC", "Carmona Branch"],
            "Manila Operation": ["Tondo Branch", "Manila Branch", "Sta. Mesa Branch", "Pandacan Branch", "Tayuman Branch", "Malate Branch"],
            "Bulacan Operation": ["Marilao Pick-Up Branch", "Marilao Delivery Branch", "Calumpit Branch", "Meycauayan Branch", "Bocaue Branch", "Santa Maria 1 Branch-San Vicente", "Santa Maria 2 Branch- Balasing", "Malolos Branch", "Paombong Branch", "Guiguinto Branch", "Pandi Branch", "Norzagaray Branch", "Plaridel Branch", "Baliuag Branch", "Valenzuela 01 Branch", "Valenzuela 02 Branch", "San Ildefonso Branch", "San Rafael Branch", "San Jose Del Monte 2", "Pulilan SC"],
            "NCR North Operation": ["Angono 001 Branch", "Antipolo 001 Branch", "Antipolo 002 Branch", "Binangonan 001 Branch", "Cainta 001 Branch", "Rodriguez 001 Branch", "San Mateo 001 Branch", "Marikina Branch"],
            "NCR South Operation": ["Makati 001 Branch", "Taguig 001 Branch", "San Juan 001 Branch", "Pasig 001 Branch", "Las Pi√±as 001 Branch", "Mandaluyong 001 Branch", "Pasig 002 Branch", "Muntinlupa 001 Branch", "Pasay 001 Branch", "Para√±aque 001 Branch", "Pateros 001 Branch", "Para√±aque 002 Branch", "Muntinlupa 002 Branch", "Las Pi√±as 002 Branch", "Makati 002 Branch", "Pasig 003 Branch", "Pasay 002 Branch"],
            "Quezon City Operation": ["Quezon City 001 Branch", "Quezon City 002 Branch", "Quezon City 003 Branch", "Quezon City 004 Branch", "Quezon City 005 Branch", "Quezon City 006 Branch", "Quezon City 007 Branch", "Quezon City 008 Branch", "Quezon City 009 Branch", "Quezon City 010 Branch"],
            "CAMANA Operation": ["North Caloocan 001 Branch", "Navotas 001 Branch", "North Caloocan 002 Branch", "South Caloocan 001 Branch", "Malabon 001 Branch", "South Caloocan 002 Branch"],
            "Pampanga Operation": ["Lubao Branch", "Angeles City 001 Branch", "Angeles City 002 Branch", "Arayat Branch", "Bacolor Branch", "San Simon Branch", "Mabalacat Branch", "Apalit Branch", "Mexico Branch", "San Fernando Branch"]
        };

        const API_URL = "https://script.google.com/macros/s/AKfycbwTiDXSQ9sHFnsNGZudsFVH3bKqGeAOHTSCQpfqGXT-FYp2zmYCcS0xYW3zJmmsgAg/exec";
        const SESSION_KEY = 'it_session';
        const LOGIN_URL = "TIcket Home Page.html";
        const SEEN_TICKETS_KEY = 'seen_ticket_ids'; // For new tickets
        const CLOSED_NOTIFIED_TICKETS_KEY = 'closed_notified_ticket_ids'; // For closed notifications

        let filteredTickets = [];
        let allTickets = [];
        let closedNotifiedTicketIds = new Set();
        let previousTicketIds = new Set();
        let previousStatusById = new Map();
        let showTodayOnly = false;
        let lastFetchTimestamp = 0;
        let newTicketNotifications = [];
        let itPersonnelList = [];
        let isChatOpen = false;
        let unreadChatCount = 0;

        // pagination
        let currentPage = 1;
        let pageSize = 50;

        // sounds
        const soundNew = document.getElementById('soundNew');
        const soundClosed = document.getElementById('soundClosed');
        soundNew.volume = 0.35;
        soundClosed.volume = 0.30;

        function updateNotificationCount() {
            const countEl = document.getElementById("notificationCount");
            const listEl = document.getElementById("notificationList");
            const count = newTicketNotifications.length;

            // Update badge
            if (count > 0) {
                countEl.textContent = count;
                countEl.style.display = "inline-block";
            } else {
                countEl.style.display = "none";
            }

            // Refresh list
            listEl.innerHTML = ""; // Clear current list

            if (count === 0) {
                const li = document.createElement('li');
                li.style.cssText = `
                    padding: 15px;
                    text-align: center;
                    color: var(--muted);
                    font-style: italic;
                    font-size: 14px;
                `;
                li.textContent = "No current notification";
                listEl.appendChild(li);
                return;
            }
            // Sort notifications by timestamp, newest first
            newTicketNotifications.sort((a, b) => b.timestamp - a.timestamp);

            newTicketNotifications.forEach(notification => {
                const li = document.createElement('li');
                li.style.cssText = `
                    padding: 10px;
                    border-bottom: 1px solid var(--row-hover);
                    font-size: 14px;
                    line-height: 1.4;
                    color: var(--text); 
                    cursor: pointer;
                `;
                li.setAttribute('data-ticket-id', notification.id);

                // Add click event to open the modal for this ticket
                li.addEventListener('click', () => {
                    const ticket = allTickets.find(t => t.colA === notification.id);
                    if (ticket) {
                        openModal(ticket.colA, ticket.colD, ticket.colF, ticket.colG, ticket.colI, ticket.colL || "", ticket.colJ || "");
                        document.getElementById("notificationDropdown").style.display = "none";
                    }
                });

                const timeAgo = notification.timestamp ? `<div style="font-size:12px; color:var(--muted); margin-top:4px;">${formatTimeAgo(notification.timestamp)}</div>` : '';

                li.innerHTML = `
                    <div>${notification.message}</div>
                    ${timeAgo}
                `;
                listEl.appendChild(li);
            });
        }

        // Toggle dropdown when bell is clicked
        document.querySelector(".notification-bell").addEventListener("click", (event) => {
            const dropdown = document.getElementById("notificationDropdown");
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
            event.stopPropagation();
        });

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
            const bell = document.querySelector(".notification-bell");
            if (!bell.contains(e.target) && document.getElementById("notificationDropdown").style.display === 'block') {
                document.getElementById("notificationDropdown").style.display = "none";
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            // Automatically open the View Ticket Summary modal at center on page load
            setTimeout(() => {
                if (allTickets && allTickets.length > 0) {
                    const t = allTickets[0];
                    openModal(t.colA, t.colD, t.colF, t.colG, t.colI, t.colL || "", t.colJ || "", t.colE || "");
                }
            }, 400);
            document.getElementById("dateFilter").value = ""; // clear date filter initially
            // Load seen tickets from localStorage
            try {
                const seen = JSON.parse(localStorage.getItem(SEEN_TICKETS_KEY) || '[]');
                previousTicketIds = new Set(seen);
                const closedNotified = JSON.parse(localStorage.getItem(CLOSED_NOTIFIED_TICKETS_KEY) || '[]');
                closedNotifiedTicketIds = new Set(closedNotified);
            } catch (e) { console.error("Could not load seen tickets", e); }

            fetchITPersonnel();

            fetchData();
            setInterval(fetchData, 10000);

            // Reset all filters & highlights
            document.getElementById("resetFiltersBtn").addEventListener("click", () => {
                document.getElementById("searchBox").value = "";
                document.getElementById("regionFilter").value = "all";
                document.getElementById("branchFilter").value = "all";
                document.getElementById("dateFilter").value = "";
                showTodayOnly = false;
                document.querySelectorAll(".stat-box").forEach(box => box.classList.remove("active"));
                currentPage = 1;
                renderTable();
                document.querySelector(".table-wrap").scrollIntoView({ behavior: "smooth" });

                showToast({
                    type: "success",
                    title: "Filters Reset",
                    message: "All filters have been cleared.",
                    meta: new Date().toLocaleString("en-PH", {
                        year: "numeric", month: "short", day: "2-digit",
                        hour: "2-digit", minute: "2-digit", hour12: true,
                        timeZone: "Asia/Manila"
                    })
                });
            });

            // Show ALL tickets
            document.getElementById("totalBox").addEventListener("click", () => {
                showTodayOnly = false;
                document.getElementById("statusFilter").value = "all";
                document.getElementById("regionFilter").value = "all";
                document.getElementById("dateFilter").value = "";
                currentPage = 1;
                renderTable();
                setActiveStatBox("totalBox");
                document.querySelector(".table-wrap").scrollIntoView({ behavior: "smooth" });
            });

            // Show only OPEN tickets
            document.getElementById("openBox").addEventListener("click", () => {
                showTodayOnly = false;
                document.getElementById("statusFilter").value = "open";
                document.getElementById("regionFilter").value = "all"; // Keep all regions
                document.getElementById("dateFilter").value = "";
                currentPage = 1;
                renderTable();
                setActiveStatBox("openBox");
                document.querySelector(".table-wrap").scrollIntoView({ behavior: "smooth" });
            });

            // Show only CLOSED tickets
            document.getElementById("closedBox").addEventListener("click", () => {
                showTodayOnly = false;
                document.getElementById("statusFilter").value = "closed";
                document.getElementById("regionFilter").value = "all"; // Keep all regions
                document.getElementById("dateFilter").value = "";
                currentPage = 1;
                renderTable();
                setActiveStatBox("closedBox");
                document.querySelector(".table-wrap").scrollIntoView({ behavior: "smooth" });
            });

            // Show only TODAY'S tickets
            document.getElementById("todayBox").addEventListener("click", () => {
                showTodayOnly = true;
                // Set region filter to user's allowed region if not admin
                const sess = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
                const userType = sess?.userType || 'User';
                const allowedRegions = sess?.regions || [];
                if (userType !== 'Admin' && allowedRegions.length === 1) {
                    document.getElementById("regionFilter").value = allowedRegions[0];
                } else {
                    document.getElementById("regionFilter").value = "all";
                }
                currentPage = 1;
                renderTable();
                setActiveStatBox("todayBox");
                document.querySelector(".table-wrap").scrollIntoView({ behavior: "smooth" });
            });

            // filters
            let searchDebounce;
            document.getElementById("searchBox").addEventListener("input", () => {
                clearTimeout(searchDebounce);
                searchDebounce = setTimeout(() => {
                    currentPage = 1;
                    renderTable();
                }, 300);
            });

            document.getElementById("statusFilter").addEventListener("change", () => { currentPage = 1; renderTable(); });
            document.getElementById("regionFilter").addEventListener("change", () => {
                currentPage = 1;
                populateBranchFilter(allTickets); // Update branches when region changes
                renderTable();
            });
            document.getElementById("branchFilter").addEventListener("change", () => { currentPage = 1; renderTable(); });
            document.getElementById("dateFilter").addEventListener("change", () => { showTodayOnly = false; currentPage = 1; renderTable(); });
            document.getElementById("todayBtn").addEventListener("click", () => {
                showTodayOnly = true;
                currentPage = 1;
                renderTable();
            });

            // pagination
            document.getElementById("firstPageBtn").addEventListener("click", () => { currentPage = 1; renderTable(); });
            document.getElementById("prevPageBtn").addEventListener("click", () => { currentPage = Math.max(1, currentPage - 1); renderTable(); });
            document.getElementById("nextPageBtn").addEventListener("click", () => {
                const totalPages = Math.max(1, Math.ceil(getFilteredTickets().length / pageSize));
                currentPage = Math.min(totalPages, currentPage + 1);
                renderTable();
            });
            document.getElementById("lastPageBtn").addEventListener("click", () => {
                const totalPages = Math.max(1, Math.ceil(getFilteredTickets().length / pageSize));
                currentPage = totalPages;
                renderTable();
            });
            document.getElementById("pageSize").addEventListener("change", (e) => {
                pageSize = parseInt(e.target.value, 10) || 50;
                currentPage = 1;
                renderTable();
            });
        });

        function formatDateTime(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;

            return date.toLocaleString("en-PH", {
                year: "numeric",
                month: "short",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: true,
                timeZone: "Asia/Manila"
            });
        }

        function formatTimeAgo(date) {
            if (!date) return "";
            const d = new Date(date);
            if (isNaN(d)) return "";

            // Format to 'MMM DD, YYYY, hh:mm A'
            return d.toLocaleString("en-US", {
                month: "short",
                day: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                hour12: true
            });
        }

        async function fetchData() {
            const res = await fetch(API_URL);
            const newData = await res.json();

            // newest first by submitted date
            newData.sort((a, b) => new Date(b.colB) - new Date(a.colB));

            populateBranchFilter(newData);
            populateRegionFilter(newData);

            const newTickets = [];
            const closedTransitions = [];

            newData.forEach(t => {
                const id = t.colA;
                const status = (t.colI || '').toLowerCase();
                if (!previousTicketIds.has(id)) {
                    newTickets.push(id);
                } else {
                    const prev = previousStatusById.get(id) || "";
                    if (prev !== "closed" && status === "closed") {
                        closedTransitions.push(id);
                    }
                }
            });

            previousTicketIds = new Set(newData.map(t => t.colA));
            previousStatusById.clear();
            newData.forEach(t => previousStatusById.set(t.colA, (t.colI || '').toLowerCase()));

            allTickets = newData;

            // Save the new complete set of IDs to localStorage
            try {
                localStorage.setItem(SEEN_TICKETS_KEY, JSON.stringify(Array.from(previousTicketIds)));
            } catch (e) { console.error("Could not save seen tickets", e); }

            // Save the closed notified IDs to localStorage
            try {
                localStorage.setItem(CLOSED_NOTIFIED_TICKETS_KEY, JSON.stringify(Array.from(closedNotifiedTicketIds)));
            } catch (e) { console.error("Could not save closed notified tickets", e); }



            try {
                if (newTickets.length) soundNew.play().catch(() => { });
                if (closedTransitions.length) soundClosed.play().catch(() => { });
            } catch (e) { }

            if (newTickets.length > 0) {
                const tableWrap = document.querySelector(".table-wrap");
                tableWrap.scrollTo({ top: 0, behavior: "smooth" });

                newTickets.forEach(ticketId => {
                    const row = document.querySelector(`#dataTable tbody tr[data-id="${ticketId}"]`);
                    if (row) {
                        row.classList.add("blink-new");
                        setTimeout(() => row.classList.remove("blink-new"), 3000);
                    }
                });
            }

            if (newTickets.length > 0) {
                const sess = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
                const userType = sess?.userType || 'User';
                const allowedRegions = (sess?.regions || []).map(r => (r || '').trim().toLowerCase());

                newTickets.forEach(ticketId => {
                    const ticket = allTickets.find(t => t.colA === ticketId);
                    if (ticket && (ticket.colI || "").toLowerCase() === "open") {

                        const ticketRegion = (ticket.colC || '').trim().toLowerCase();
                        const isUserAdmin = userType === 'Admin';
                        const isRegionAllowed = allowedRegions.includes(ticketRegion);

                        if (isUserAdmin || isRegionAllowed) {
                            newTicketNotifications.push({
                                id: ticket.colA,
                                message: `<strong>New Ticket #${ticket.colA}</strong>: ${ticket.colF} issue at ${ticket.colD}`,
                                timestamp: new Date(ticket.colB)
                            });

                            showNotification(
                                `<strong>üÜï New Ticket Received</strong>`,
                                `Ticket #${ticket.colA} ‚Äî ${ticket.colF} issue at ${ticket.colD}`,
                                "success"
                            );
                        }
                    }
                });
            }

            if (closedTransitions.length > 0) {
                closedTransitions.forEach(ticketId => {
                    // Only show notification if we haven't shown it before
                    if (!closedNotifiedTicketIds.has(ticketId)) {
                        const ticket = allTickets.find(t => t.colA === ticketId);
                        if (ticket) {
                            newTicketNotifications = newTicketNotifications.filter(n => n.id !== ticketId);

                            showNotification(
                                `<strong>‚úîÔ∏è Ticket Closed</strong>`,
                                `Ticket #${ticket.colA} was closed successfully.`,
                                "error"
                            );
                            closedNotifiedTicketIds.add(ticketId); // Remember we notified for this one
                        }
                    }
                });
            }

            updateNotificationCount();
            renderTable(newTickets, closedTransitions);
        }
        function populateRegionFilter(tickets) {
            const regionFilter = document.getElementById("regionFilter");
            if (!regionFilter) return;

            const sess = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
            const userType = sess?.userType || 'User';
            const allowedRegions = sess?.regions || [];

            let regionSet;
            if (userType === 'Admin') {
                // Admin sees all regions from the data
                regionSet = new Set(tickets.map(t => (t.colC || "").trim()).filter(Boolean));
            } else {
                // User sees only their assigned regions
                regionSet = new Set(allowedRegions.filter(Boolean));
            }

            const regions = [...regionSet].sort();

            const currentSelection = regionFilter.value;
            regionFilter.innerHTML = `<option value="all">All Regions</option>`; // Reset

            regions.forEach(r => {
                const opt = document.createElement("option");
                opt.value = r;
                opt.textContent = r;
                regionFilter.appendChild(opt);
            });

            if ([...regionFilter.options].some(o => o.value === currentSelection)) {
                regionFilter.value = currentSelection;
            }
        }

        function populateBranchFilter(tickets) {
            const branchFilter = document.getElementById("branchFilter");
            if (!branchFilter) return;

            const sess = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
            const userType = sess?.userType || 'User';
            const allowedRegions = sess?.regions || [];
            const allowedRegionsNormalized = allowedRegions.map(r => (r || '').trim().toLowerCase());
            const selectedRegion = document.getElementById("regionFilter").value;

            const branchSet = new Set();

            tickets.forEach(t => {
                const branch = (t.colD || "").toString().trim();
                const region = (t.colC || "").toString().trim().toLowerCase();

                if (!branch) return;

                // If a specific region is selected, only show branches for that region
                if (selectedRegion !== 'all' && region.toLowerCase() !== selectedRegion.toLowerCase()) {
                    return;
                }

                if (userType === 'Admin') {
                    branchSet.add(branch);
                } else {
                    if (allowedRegionsNormalized.includes(region)) {
                        branchSet.add(branch);
                    }
                }
            });

            const branches = [...branchSet].sort((a, b) => a.localeCompare(b));

            const currentSelection = branchFilter.value;
            branchFilter.innerHTML = `<option value="all">All Branches</option>`;

            branches.forEach(b => {
                const opt = document.createElement("option");
                opt.value = b;
                opt.textContent = b;
                branchFilter.appendChild(opt);
            });

            if ([...branchFilter.options].some(o => o.value === currentSelection)) {
                branchFilter.value = currentSelection;
            }
        }

        function getFilteredTickets() {
            const search = document.getElementById("searchBox").value.toLowerCase();
            const statusFilter = document.getElementById("statusFilter").value;
            const regionFilter = document.getElementById("regionFilter").value;
            const branchFilter = document.getElementById("branchFilter").value;
            const dateFilter = document.getElementById("dateFilter").value;

            const sess = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
            const userType = sess?.userType || 'User';
            const allowedRegions = sess?.regions || [];

            const allowedRegionsNormalized = allowedRegions.map(r => (r || '').toString().trim().toLowerCase());

            let baseTickets = allTickets || [];

            if (userType !== 'Admin') {
                if (allowedRegionsNormalized.length > 0) {
                    baseTickets = baseTickets.filter(t =>
                        allowedRegionsNormalized.includes(((t.colC || '').toString()).trim().toLowerCase())
                    );
                } else {
                    baseTickets = [];
                }
            }

            return baseTickets.filter(t => {
                let match = true;

                if (showTodayOnly) {
                    const today = new Date();
                    const ticketDate = new Date(t.colB);
                    if (
                        ticketDate.getFullYear() !== today.getFullYear() ||
                        ticketDate.getMonth() !== today.getMonth() ||
                        ticketDate.getDate() !== today.getDate()
                    ) {
                        return false;
                    }
                }

                if (search) {
                    const haystack = [
                        t.colA, t.colB, t.colC, t.colD, t.colE,
                        t.colF, t.colG, t.colJ, t.colK, t.colL, t.colM, t.colN, t.colO, t.colP
                    ].join(" ").toLowerCase();
                    match = haystack.includes(search);
                }

                if (match && statusFilter !== "all") {
                    if (statusFilter === "open" && (t.colI || "").toLowerCase() !== "open") match = false;
                    if (statusFilter === "closed" && (t.colI || "").toLowerCase() !== "closed") match = false;
                }

                if (match && regionFilter !== "all") {
                    if ((t.colC || "").toLowerCase() !== regionFilter.toLowerCase()) match = false;
                }

                if (match && branchFilter !== "all") {
                    const branch = (t.colD || "").toString();
                    const region = (t.colC || "").toString();
                    const personnel = (t.colJ || "").toString();

                    if (branch !== branchFilter && region !== branchFilter && personnel !== branchFilter) {
                        match = false;
                    }
                }

                if (match) {
                    const ticketDate = new Date(t.colB);
                    if (dateFilter) { // dateFilter is 'YYYY-MM-DD'
                        const [year, month, day] = dateFilter.split('-').map(Number);
                        // Create date in local timezone to avoid UTC issues
                        const startOfDay = new Date(year, month - 1, day, 0, 0, 0, 0);
                        const endOfDay = new Date(year, month - 1, day, 23, 59, 59, 999);
                        if (ticketDate < startOfDay || ticketDate > endOfDay) match = false;
                    }
                }

                return match;
            });
        }

        function renderTable(newTickets = [], closedTransitions = []) {
            const tbody = document.querySelector("#dataTable tbody");
            tbody.innerHTML = "";

            newTickets = (newTickets || []).map(x => String(x));
            closedTransitions = (closedTransitions || []).map(x => String(x));

            const filtered = getFilteredTickets();

            const start = (currentPage - 1) * pageSize;
            const ordered = filtered;

            const paged = ordered.slice(start, start + pageSize);

            paged.forEach(ticket => {
                const id = ticket.colA;
                const ticketStatusLower = (ticket.colI || '').toLowerCase();
                const repairStatusLower = (ticket.colL || '').toLowerCase();

                const tr = document.createElement("tr");
                tr.dataset.ticketId = id;

                if (ticketStatusLower === "closed") {
                    tr.classList.add("closed-row");
                } else if (ticketStatusLower === "open" && ['in-progress', 'pending', 'on-hold'].includes(repairStatusLower)) {
                    // Apply special highlight for open tickets that are being worked on
                    tr.classList.add("open-in-progress-row");
                }

                if (newTickets.includes(String(id))) tr.classList.add("highlight-new");
                if (closedTransitions.includes(String(id))) tr.classList.add("highlight-closed");

                const createCell = (text) => {
                    const td = document.createElement('td');
                    td.textContent = text || '';
                    return td;
                };

                const createDateTimeCell = (dateStr) => {
                    const td = document.createElement('td');
                    if (!dateStr) {
                        td.innerHTML = '';
                        return td;
                    }
                    const date = new Date(dateStr);
                    if (isNaN(date)) {
                        td.innerHTML = dateStr;
                        return td;
                    }

                    const datePart = date.toLocaleDateString("en-PH", { year: "numeric", month: "short", day: "2-digit", timeZone: "Asia/Manila" });
                    const timePart = date.toLocaleTimeString("en-PH", { hour: "2-digit", minute: "2-digit", hour12: true, timeZone: "Asia/Manila" });
                    td.innerHTML = `${datePart}<br><small style="color: var(--muted);">${timePart}</small>`;
                    return td;
                };

                tr.appendChild(createCell(ticket.colA));
                tr.appendChild(createDateTimeCell(ticket.colB));
                tr.appendChild(createCell(ticket.colC));

                // New combined cell for Branch and ReportedBy
                const reportedByCell = document.createElement('td');
                reportedByCell.innerHTML = `${ticket.colD || ''}<br><small style="color: var(--muted);">${ticket.colE || ''}</small>`;
                tr.appendChild(reportedByCell);

                // New combined cell for Device and Problem Description
                const issueCell = document.createElement('td');
                let deviceHtml = ticket.colF || '';
                if (ticket.colQ) { // colQ is Asset Code
                    deviceHtml = `<span title="Asset Code: ${ticket.colQ}">${deviceHtml}</span>`;
                }
                issueCell.innerHTML = `${deviceHtml}<br><small style="color: var(--muted);">${ticket.colG || ''}</small>`;
                tr.appendChild(issueCell);

                // Photo Cell
                const photoCell = document.createElement('td');
                photoCell.style.textAlign = 'center'; // Center the content
                const fullImageUrl = (ticket.colH || '').trim();
                if (fullImageUrl && /^https?:\/\//i.test(fullImageUrl)) {
                    let thumbnailUrl = fullImageUrl;
                    let modalImageUrl = fullImageUrl; // Use a separate variable for the modal
                    if (fullImageUrl.includes('drive.google.com')) {
                        const fileIdMatch = fullImageUrl.match(/[\/d\/]([a-zA-Z0-9_-]{25,})|id=([a-zA-Z0-9_-]{25,})/);
                        if (fileIdMatch) {
                            const fileId = fileIdMatch[1] || fileIdMatch[2];
                            thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}`;
                            modalImageUrl = `https://drive.google.com/thumbnail?id=${fileId}`; // Use thumbnail for modal as requested
                        }
                    }
                    const img = document.createElement('img');
                    img.src = thumbnailUrl;
                    img.alt = 'Ticket Photo';
                    img.className = 'photo-thumbnail';
                    img.onclick = () => openImagePreviewModal(modalImageUrl);
                    photoCell.appendChild(img);
                } else {
                    photoCell.innerHTML = '<span style="color:#999;cursor:default;">‚Äî</span>';
                }
                tr.appendChild(photoCell);

                // Ticket Status Cell
                const statusCell = document.createElement('td');
                if (ticketStatusLower === 'open') {
                    const statusBtn = document.createElement('span');
                    statusBtn.className = 'status-btn open';
                    statusBtn.title = 'Click to Assign IT Staff, Status OPEN.';
                    statusBtn.textContent = ticket.colI || 'Open';
                    statusBtn.onclick = () => openModal(ticket.colA, ticket.colD, ticket.colF, ticket.colG, ticket.colI, ticket.colL || "", ticket.colJ || "", ticket.colQ || "");
                    statusCell.appendChild(statusBtn);
                } else {
                    const statusText = document.createElement('span');
                    statusText.className = 'status-closed-text';
                    statusText.title = 'This ticket is already Closed.';
                    statusText.textContent = ticket.colI || 'Closed';
                    statusCell.appendChild(statusText);
                }
                tr.appendChild(statusCell);

                tr.appendChild(createCell(ticket.colJ));
                tr.appendChild(createDateTimeCell(ticket.colM));

                // Repair Status Cell
                const repairCell = document.createElement('td');
                if (ticket.colL) {
                    const repairSpan = document.createElement('span');
                    const statusKey = ticket.colL.toLowerCase().replace(/\s+/g, "-");
                    repairSpan.className = `repair-status ${statusKey}`;
                    repairSpan.textContent = ticket.colL;
                    // Button style for all statuses
                    repairSpan.style.display = 'inline-block';
                    repairSpan.style.padding = '4px 10px';
                    repairSpan.style.fontSize = '13px';
                    repairSpan.style.fontWeight = '700';
                    repairSpan.style.borderRadius = '6px';
                    repairSpan.style.textAlign = 'center';
                    repairSpan.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    repairSpan.style.color = '#fff';
                    repairSpan.style.cursor = 'pointer';
                    repairSpan.style.userSelect = 'none';
                    // Color by status
                    if (statusKey === 'completed') repairSpan.style.background = '#22c55e';
                    else if (statusKey === 'not-fixed') repairSpan.style.background = '#dc3545';
                    else if (statusKey === 'in-progress') repairSpan.style.background = '#f59e0b';
                    else if (statusKey === 'pending') repairSpan.style.background = '#3b82f6';
                    else if (statusKey === 'on-hold') repairSpan.style.background = '#17a2b8';
                    else repairSpan.style.background = '#888';
                    repairCell.appendChild(repairSpan);
                }
                tr.appendChild(repairCell);

                // Summary Button Cell
                const summaryCell = document.createElement('td');
                const summaryBtn = document.createElement('button');
                summaryBtn.className = 'view-summary-btn';
                summaryBtn.title = 'Click to view ticket summary report.';
                summaryBtn.innerHTML = '<i class="fas fa-file-lines"></i>';
                summaryBtn.onclick = () => openSummaryModal(ticket.colA, ticket.colB, ticket.colD, ticket.colF, ticket.colG, ticket.colJ, ticket.colI, ticket.colM, ticket.colP, ticket.colO, ticket.colQ, ticket.colL);
                summaryCell.appendChild(summaryBtn);
                tr.appendChild(summaryCell);

                tbody.appendChild(tr);
            });

            document.getElementById("dataTable").style.display = filtered.length > 0 ? "table" : "none";

            // stats
            document.getElementById("totalTickets").innerText = filtered.length;
            document.getElementById("openTickets").innerText = filtered.filter(t => (t.colI || "").toLowerCase() === "open").length;
            document.getElementById("closedTickets").innerText = filtered.filter(t => (t.colI || "").toLowerCase() === "closed").length;

            // Show tickets created today for the logged-in user's allowed regions only
            const today = new Date();
            const sess = JSON.parse(localStorage.getItem(SESSION_KEY) || 'null');
            const userType = sess?.userType || 'User';
            const allowedRegions = (sess?.regions || []).map(r => (r || '').trim().toLowerCase());
            let ticketsForTodayCount = allTickets || [];
            if (userType !== 'Admin' && allowedRegions.length > 0) {
                ticketsForTodayCount = ticketsForTodayCount.filter(t => {
                    const ticketRegion = (t.colC || '').trim().toLowerCase();
                    return allowedRegions.includes(ticketRegion);
                });
            }
            const todayCount = ticketsForTodayCount.filter(t => {
                const ticketDate = new Date(t.colB);
                return ticketDate.getFullYear() === today.getFullYear() &&
                    ticketDate.getMonth() === today.getMonth() &&
                    ticketDate.getDate() === today.getDate();
            }).length;
            document.getElementById("todayTickets").innerText = todayCount;

            // page info
            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            const startItem = filtered.length > 0 ? start + 1 : 0;
            const endItem = Math.min(start + pageSize, filtered.length);
            const pageText = `Page ${currentPage} of ${totalPages} ‚Ä¢ Showing ${startItem}‚Äì${endItem} of ${filtered.length}`;
            document.getElementById("pageInfo").innerText = pageText;

            // Blink animation for new tickets
            if (newTickets.length > 0) {
                newTickets.forEach(ticketId => {
                    const row = document.querySelector(`#dataTable tbody tr[data-ticket-id="${ticketId}"]`);
                    if (row) {
                        row.classList.add("blink-new");
                        setTimeout(() => row.classList.remove("blink-new"), 3000);
                    }
                });
            }
        }

        async function fetchITPersonnel() {
            const USERS_API_URL = "https://script.google.com/macros/s/AKfycbwTiDXSQ9sHFnsNGZudsFVH3bKqGeAOHTSCQpfqGXT-FYp2zmYCcS0xYW3zJmmsgAg/exec";
            try {
                const url = new URL(USERS_API_URL);
                url.searchParams.set('action', 'getUsers');

                const response = await fetch(url);
                const users = await response.json();

                if (users && users.success && Array.isArray(users.data)) {
                    itPersonnelList = users.data.map(user => user.fullName).sort();
                }
            } catch (error) {
                console.error("Failed to fetch IT personnel list:", error);
            }
        }

        function openModal(ticketId, branch, device, problem, ticketStatus, repairStatus, personnel, assetCode) {
            document.getElementById("modalTicketId").value = ticketId;
            document.getElementById("modalTicketNumber").textContent = ticketId;
            document.getElementById("modalBranch").textContent = branch || "";
            document.getElementById("modalAssetCode").textContent = assetCode || "";
            document.getElementById("modalDevice").textContent = device || "";
            document.getElementById("modalProblem").textContent = problem || "";
            document.getElementById("modalTicketStatus").textContent = ticketStatus || "";
            document.getElementById("modalRepairStatusText").textContent = repairStatus || "";

            const personnelSelect = document.getElementById("modalPersonnel");

            personnelSelect.innerHTML = '<option value="">-- Select Personnel --</option>';
            itPersonnelList.forEach(name => { // Filter out blank names
                if (name && name.trim() !== "") {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    personnelSelect.appendChild(option);
                }
            });

            const assignedInfo = document.getElementById("assignedInfo");

            personnelSelect.value = "";
            personnelSelect.disabled = false;
            assignedInfo.style.display = "none";
            document.getElementById("modalParts").value = "";
            document.getElementById("modalRemarks").value = "";

            const modalStatusSelect = document.getElementById("modalStatus");
            const currentRepairStatus = (repairStatus || "pending").toLowerCase().replace(/\s+/g, '-');
            if ([...modalStatusSelect.options].some(opt => opt.value === currentRepairStatus)) {
                modalStatusSelect.value = currentRepairStatus;
            }

            if (personnel && personnel.trim() !== "") {
                personnelSelect.value = personnel;
                personnelSelect.disabled = true;
                assignedInfo.innerHTML = `Already assigned to ${personnel}. <u>Click to change.</u>`;
                assignedInfo.style.cursor = 'pointer';
                assignedInfo.style.display = "block";

                assignedInfo.onclick = () => {
                    personnelSelect.disabled = false;
                    personnelSelect.focus();
                    assignedInfo.style.display = 'none';
                    assignedInfo.onclick = null;
                };
            }

            document.getElementById("statusModal").style.display = "flex";
        }

        function closeModal() {
            document.getElementById("statusModal").style.display = "none";
            document.getElementById('transferPanel').style.display = 'none';
        }

        async function confirmUpdate() {
            const ticketId = document.getElementById("modalTicketId").value;
            const personnel = document.getElementById("modalPersonnel").value;
            const status = document.getElementById("modalStatus").value;
            const parts = document.getElementById("modalParts").value;
            const remarks = document.getElementById("modalRemarks").value;

            if (!personnel || !status) {
                alert("Please select both IT personnel and repair status.");
                return;
            }

            const params = new URLSearchParams({
                action: "updateStatus", id: ticketId, personnel, status, parts, remarks
            });

            document.getElementById('spinnerOverlay').classList.add('show');

            try {
                const resp = await fetch(`${API_URL}?${params.toString()}`, { method: "GET" });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

                closeModal();
                fetchData();

                const ts = new Date().toLocaleString("en-PH", {
                    year: "numeric", month: "short", day: "2-digit",
                    hour: "2-digit", minute: "2-digit", hour12: true,
                    timeZone: "Asia/Manila"
                });
                showToast({
                    type: "success",
                    title: "Ticket Updated",
                    message: `Ticket #${ticketId} set to "${status}" by ${personnel}.`,
                    meta: ts
                });
            } catch (err) {
                const ts = new Date().toLocaleString("en-PH", {
                    year: "numeric", month: "short", day: "2-digit",
                    hour: "2-digit", minute: "2-digit", hour12: true,
                    timeZone: "Asia/Manila"
                });
                showToast({
                    type: "error",
                    title: "Update Failed",
                    message: `Could not update Ticket #${ticketId}. Please try again.`,
                    meta: `Reason: ${err?.message || 'Network error'} ‚Ä¢ ${ts}`
                });
            } finally {
                document.getElementById('spinnerOverlay').classList.remove('show');
            }
        }

        function openSummaryModal(ticketNumber, submissionDate, branch, device, problem, personnel, status, completion, results, closure, assetCode, repairStatus) {
            const modalBody = document.getElementById("summaryModalBody");

            if (!modalBody) {
                console.error("‚ùå summaryModalBody not found in DOM!");
                return;
            }

            let timeToClose = "Ticket is not yet closed";
            if (submissionDate && closure) {
                const start = new Date(submissionDate);
                const end = new Date(closure);
                if (!isNaN(start) && !isNaN(end)) {
                    let diffMs = end - start;
                    const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    diffMs -= days * (1000 * 60 * 60 * 24);
                    const hours = Math.floor(diffMs / (1000 * 60 * 60));
                    diffMs -= hours * (1000 * 60 * 60);
                    const minutes = Math.floor(diffMs / (1000 * 60));

                    let parts = [];
                    if (days > 0) parts.push(`${days} day${days > 1 ? 's' : ''}`);
                    if (hours > 0) parts.push(`${hours} hour${hours > 1 ? 's' : ''}`);
                    if (minutes > 0) parts.push(`${minutes} minute${minutes > 1 ? 's' : ''}`);
                    timeToClose = parts.join(', ') || 'Less than a minute';
                }
            }
            modalBody.innerHTML = `
                <input type="hidden" id="summaryTicketId" value="${ticketNumber || ''}">
                <div class="summary-section">
                    <h3><i class="fas fa-ticket-alt"></i> Ticket Details</h3>
                    <div class="summary-item">
                        <span class="summary-label">Ticket Number</span>
                        <span class="summary-value highlight">${ticketNumber || ''}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Asset Code</span>
                        <span class="summary-value asset-code-barcode">${assetCode ? `*${assetCode}*` : ""}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Branch</span>
                        <span class="summary-value">${branch || ''}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Device & Problem</span>
                        <span class="summary-value">${device || ''}<br><small>${problem || ''}</small></span>
                    </div>
                </div>
                <div class="summary-section">
                    <h3><i class="fas fa-tools"></i> Repair Details</h3>
                    <div class="summary-item">
                        <span class="summary-label">IT Assigned</span>
                        <span class="summary-value">${personnel || ''}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Repair Status</span>
                        <span class="summary-value repair-status ${repairStatus?.toLowerCase().replace(/\s+/g, "-") || ""}">${repairStatus || ''}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Repair Completion Time</span>
                        <span class="summary-value">${completion ? formatDateTime(completion) : '‚Äî'}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Ticket Duration</span>
                        <span class="summary-value highlight">${timeToClose}</span>
                    </div>
                </div>
            `;

            document.getElementById("summaryModal").style.display = "flex";

            // Add event listener for the new print button
            document.getElementById('printSummaryBtn').onclick = () => {
                const ticketId = document.getElementById('summaryTicketId').value; // Get the ticket ID from the summary
                openPrintIframeModal(ticketId); // Open the print modal
                closeSummaryModal(); // Close the summary modal
            };

            // Enable/disable print button based on repair status
            const printBtn = document.getElementById('printSummaryBtn');
            const finalStatus = (repairStatus || "").toLowerCase();
            if (finalStatus === 'completed' || finalStatus === 'not-fixed' || finalStatus === 'not fixed') {
                printBtn.disabled = false;
                printBtn.style.opacity = '1';
                printBtn.style.cursor = 'pointer';
                printBtn.title = 'Print this ticket report.';
                printBtn.querySelector('span').textContent = 'Print Report';
            } else {
                printBtn.disabled = true;
                printBtn.style.opacity = '0.5';
                printBtn.style.cursor = 'not-allowed';
                printBtn.title = 'Printing is only available for Completed or Not-Fixed tickets.';
                printBtn.querySelector('span').textContent = 'Print (Disabled)';
            }
        }

        function closeSummaryModal() {
            document.getElementById("summaryModal").style.display = "none";
        }

        function populateTransferBranches() {
            const region = document.getElementById('transferRegionSelect').value;
            const branchSelect = document.getElementById('transferBranchSelect');
            branchSelect.innerHTML = '<option value="">-- Select Branch --</option>';

            if (regionBranches[region]) {
                regionBranches[region].forEach(branchName => {
                    const option = document.createElement('option');
                    option.value = branchName;
                    option.textContent = branchName;
                    branchSelect.appendChild(option);
                });
            }
        }


        function toggleTransferPanel() {
            const panel = document.getElementById('transferPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        async function transferTicket() {
            const ticketId = document.getElementById("modalTicketId").value;
            const newRegion = document.getElementById("transferRegionSelect").value;
            const newBranch = document.getElementById("transferBranchSelect").value;

            if (!newRegion) {
                showToast({ type: 'error', title: 'Error', message: 'Please select a new region to transfer the ticket to.' });
                return;
            }

            if (!newBranch) {
                showToast({ type: 'error', title: 'Error', message: 'Please select a new branch.' });
                return;
            }

            if (!confirm(`Are you sure you want to transfer Ticket #${ticketId} to ${newRegion} (${newBranch})? This cannot be undone.`)) {
                return;
            }

            const formData = new FormData();
            formData.append('action', 'transferTicket');
            formData.append('ticketId', ticketId);
            formData.append('newRegion', newRegion);
            formData.append('newBranch', newBranch);

            document.getElementById('spinnerOverlay').classList.add('show');

            try {
                const resp = await fetch(API_URL, { method: "POST", body: formData });
                const result = await resp.json();

                if (result.success) {
                    showToast({ type: "success", title: "Ticket Transferred", message: `Ticket #${ticketId} has been moved to ${newRegion}.` });
                    closeModal();
                    fetchData();
                } else {
                    throw new Error(result.message || 'Unknown error from server.');
                }
            } catch (err) {
                console.error("Transfer Error:", err);
                showToast({ type: "error", title: "Transfer Failed", message: `Could not transfer ticket. Reason: ${err.message}` });
            } finally {
                document.getElementById('spinnerOverlay').classList.remove('show');
            }
        }

        function openStatisticsModal() {
            document.getElementById("statisticsFrame").src = "Statistic.html";
            document.getElementById("statisticsModal").style.display = "flex";
        }

        function closeStatisticsModal() {
            document.getElementById("statisticsFrame").src = "";
            document.getElementById("statisticsModal").style.display = "none";
        }

        function openItPersonnelModal() {
            const iframe = document.getElementById("itPersonnelFrame");
            iframe.src = "IT Personnel.html";
            document.getElementById("itPersonnelModal").style.display = "flex";
            // Wait for iframe to load, then send user info
            iframe.onload = function () {
                // Example: get user info from session/localStorage
                const sess = JSON.parse(localStorage.getItem('it_session') || 'null');
                if (sess) {
                    iframe.contentWindow.postMessage({ type: "USER_INFO", data: sess }, "*");
                }
            };
        }

        function closeItPersonnelModal() {
            document.getElementById("itPersonnelFrame").src = "";
            document.getElementById("itPersonnelModal").style.display = "none";
        }

        function openSubmitTicketModal() {
            const iframe = document.getElementById("submitTicketFrame");
            iframe.src = "Ticket Home Page.html?action=submit"; // Load the page and trigger the modal
            document.getElementById("submitTicketModal").style.display = "flex";
        }

        function closeSubmitTicketModal() {
            document.getElementById("submitTicketFrame").src = "";
            document.getElementById("submitTicketModal").style.display = "none";
        }

        function toggleChatIframeModal() {
            const chatModal = document.getElementById('chatIframeModal');
            if (chatModal.style.display === 'block') {
                closeChatIframeModal();
            } else {
                openChatIframeModal();
            }
        }

        function openChatIframeModal() {
            isChatOpen = true;
            unreadChatCount = 0; // Reset count when opening
            document.getElementById('chatFrame').src = 'chat.html';
            document.getElementById('chatIframeModal').style.display = 'block'; // Use 'block' to match the CSS override
            updateChatNotificationBadge(); // Hide badge
        }

        function closeChatIframeModal() {
            isChatOpen = false;
            document.getElementById('chatIframeModal').style.display = 'none';
            document.getElementById('chatFrame').src = '';
        }

        function updateChatNotificationBadge() {
            const chatCountEl = document.getElementById('chatNotificationCount');
            if (unreadChatCount > 0 && !isChatOpen) {
                chatCountEl.textContent = unreadChatCount > 9 ? '9+' : unreadChatCount;
                chatCountEl.style.display = 'block';
            } else {
                chatCountEl.style.display = 'none';
            }
        }


        function openPrintIframeModal(ticketId) {
            const iframe = document.getElementById("printFrame");
            iframe.src = `prints.html?ticket=${encodeURIComponent(ticketId)}`;
            document.getElementById("printIframeModal").style.display = "flex";
        }

        function closePrintIframeModal() {
            document.getElementById("printIframeModal").style.display = "none";
            document.getElementById("printFrame").src = "";
        }

        function openImagePreviewModal(imageUrl) {
            document.getElementById('previewImage').src = imageUrl;
            document.getElementById('imagePreviewModal').style.display = 'flex';
        }

        function closeImagePreviewModal() {
            document.getElementById('imagePreviewModal').style.display = 'none';
            document.getElementById('previewImage').src = ''; // Clear src
        }

        function showNotification(title, message, type = "success") {
            const container = document.getElementById("notificationContainer");

            const notif = document.createElement("div");
            notif.className = `notification ${type}`;
            notif.innerHTML = `${title}<div>${message}</div>`;

            container.appendChild(notif);

            setTimeout(() => {
                notif.remove(); // Remove after animation completes (slideIn 0.4s + fadeOut delay 4.5s + fadeOut duration 0.9s)
            }, 5500);
        }


        // Make modal draggable
        (function () {
            const modal = document.getElementById('statusModal');
            const box = modal.querySelector('.modal-content');
            let dragging = false, offsetX = 0, offsetY = 0;

            const onDown = (e) => {
                if (getComputedStyle(modal).display === 'none') return;
                dragging = true;
                const rect = box.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                box.style.position = 'fixed';
                box.style.margin = '0';
                box.style.left = rect.left + 'px';
                box.style.top = rect.top + 'px';
            };

            const onMove = (e) => {
                if (!dragging) return;
                const x = Math.max(8, Math.min(window.innerWidth - box.offsetWidth - 8, e.clientX - offsetX));
                const y = Math.max(8, Math.min(window.innerHeight - box.offsetHeight - 8, e.clientY - offsetY));
                box.style.left = x + 'px';
                box.style.top = y + 'px';
            };

            const onUp = () => { dragging = false; };

            box.addEventListener('mousedown', onDown);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);

            const mo = new MutationObserver(() => {
                if (getComputedStyle(modal).display !== 'none') {
                    box.style.position = 'relative';
                    box.style.left = '';
                    box.style.top = '';
                    box.style.margin = '5% auto';
                }
            });
            mo.observe(modal, { attributes: true, attributeFilter: ['style', 'class'] });
        })();

        // Make SUMMARY modal draggable
        (function () {
            const modal = document.getElementById('summaryModal');
            const box = modal.querySelector('.modal-content');
            let dragging = false, offsetX = 0, offsetY = 0;

            const onDown = (e) => {
                if (getComputedStyle(modal).display === 'none' || e.target.tagName === 'BUTTON') return;
                dragging = true;
                const rect = box.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                box.style.position = 'fixed';
                box.style.margin = '0';
                box.style.left = rect.left + 'px';
                box.style.top = rect.top + 'px';
            };

            const onMove = (e) => {
                if (!dragging) return;
                const x = Math.max(8, Math.min(window.innerWidth - box.offsetWidth - 8, e.clientX - offsetX));
                const y = Math.max(8, Math.min(window.innerHeight - box.offsetHeight - 8, e.clientY - offsetY));
                box.style.left = x + 'px';
                box.style.top = y + 'px';
            };

            const onUp = () => { dragging = false; };

            box.addEventListener('mousedown', onDown);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        })();

        // Toast helper (success + error)
        function showToast({ type = "success", title = "", message = "", meta = "" } = {}) {
            if (!document.body.contains(document.getElementById('toastContainer'))) return;
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || 'üîî'}</div>
                <div>
                    <div class="title">${title}</div>
                    <div>${message}</div>
                    ${meta ? `<div class="meta">${meta}</div>` : ''}
                </div>
                <button aria-label="Dismiss" onclick="this.closest('.toast').classList.remove('show')">‚úñ</button>
            `;

            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 50);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        function checkSession() {
            let sess = localStorage.getItem(SESSION_KEY);

            if (sess) {
                // Session found, proceed immediately.
                initializeUser(sess);
            } else {
                // Session not found. Wait a moment for it to sync from another tab.
                // This prevents accidental logouts when opening the dashboard in a new tab.
                setTimeout(() => {
                    sess = localStorage.getItem(SESSION_KEY);
                    if (sess) {
                        initializeUser(sess);
                    } else {
                        window.location.replace(LOGIN_URL);
                    }
                }, 500); // Wait 500ms
                return; // Exit the function for now
            }
        }

        // NEW: Helper function to initialize user info from session
        function initializeUser(sessionString) {
            try {
                const sessionData = JSON.parse(sessionString);
                document.getElementById('userGreeting').textContent = sessionData.fullName || sessionData.username;
                document.getElementById('userTypeDisplay').textContent = sessionData.userType || 'User';

                const profilePicEl = document.getElementById('userProfilePic');
                if (sessionData.profilePicUrl) {
                    let url = sessionData.profilePicUrl;

                    if (url.includes('drive.google.com')) {
                        const fileId = url.split(/[\/|=]/).pop();
                        if (fileId) {
                            url = `https://drive.google.com/thumbnail?id=${fileId}`;
                        }
                    }
                    profilePicEl.src = url;
                    profilePicEl.onerror = function () { this.src = 'https://i.imgur.com/8bXVn5d.png'; };
                } else {
                    profilePicEl.src = 'https://i.imgur.com/8bXVn5d.png';
                }

                const chatTitleEl = document.getElementById('chatModalTitle');
                if (chatTitleEl) {
                    chatTitleEl.textContent = `üí¨ Chat as ${sessionData.fullName || sessionData.username}`;
                }
            } catch (e) {
                console.error("Failed to parse session data, logging out.", e);
                logout();
            }
        }

        function logout() {
            localStorage.removeItem(SESSION_KEY);
            window.location.replace(LOGIN_URL);
        }

        function openProfileIframe() {
            document.getElementById('profileFrame').src = 'UserProfile.html';
            document.getElementById('profileIframeModal').style.display = 'flex';
        }

        function closeProfileIframe() {
            document.getElementById('profileIframeModal').style.display = 'none';
            document.getElementById('profileFrame').src = '';
        }

        // Listen for storage changes to auto-update profile info
        window.addEventListener('storage', (event) => {
            // Check if the 'it_session' key was the one that changed
            if (event.key === SESSION_KEY) {
                console.log('Session data updated. Refreshing dashboard header.');
                checkSession(); // Re-run session check to update the UI
            }
        });

        // Listen for messages from iframes (e.g., IT Personnel page)
        window.addEventListener('message', (event) => {
            // Check for deletion from the old implementation
            const isUserDeleted = event.data && event.data.type === 'USER_DELETED';
            // Check for any modification (add, update, delete) from the new implementation
            const isPersonnelModified = event.data && event.data.type === 'PERSONNEL_MODIFIED';

            if (isUserDeleted || isPersonnelModified) {
                console.log('Personnel data changed. Refreshing dashboard.');
                showToast({
                    type: 'info',
                    title: 'Personnel Update',
                    message: 'IT personnel list has been modified. Refreshing data.'
                });
                Promise.all([fetchData(), fetchITPersonnel()]); // Re-fetch all ticket and user data
            }

            // Listen for messages from the chat iframe
            if (event.data && event.data.type === 'NEW_CHAT_MESSAGE') {
                if (!isChatOpen) {
                    unreadChatCount += event.data.newMessagesCount || 0;
                    updateChatNotificationBadge();
                }
            }
        });

        /* === NEW: Manual Icon Notification Logic === */
        document.addEventListener('DOMContentLoaded', () => {
            const manualNotification = document.getElementById('manualNotification');

            // Function to show and then hide the notification
            function showManualNotification() {
                if (!manualNotification) return;
                manualNotification.style.opacity = '1';
                manualNotification.style.transform = 'translateY(0) scale(1)';

                setTimeout(() => {
                    manualNotification.style.opacity = '0';
                    manualNotification.style.transform = 'translateY(10px) scale(0.95)';
                }, 3000); // Hide after 3 seconds
            }
            setInterval(showManualNotification, 30000); // Show every 30 seconds
        });


        function setActiveStatBox(boxId) {
            document.querySelectorAll(".stat-box").forEach(box => box.classList.remove("active"));
            document.getElementById(boxId).classList.add("active");
        }

        // Check session on page load
        checkSession();

        // Make Filters + Pagination sticky with shadow
        document.addEventListener("scroll", () => {
            const filters = document.querySelector(".filters-pagination-container");
            if (!filters) return;

            if (window.scrollY > 40) {
                filters.classList.add("sticky");
            } else {
                filters.classList.remove("sticky");
            }
        });

        // Close modals with Escape key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeSummaryModal();
                closeStatisticsModal();
                closeItPersonnelModal();
                closePrintIframeModal();
                closeSubmitTicketModal();
                closeImagePreviewModal();
                closeChatIframeModal();
            }
        });

        // Internet connection status
        window.addEventListener('offline', () => {
            showToast({
                type: 'error',
                title: 'No Internet Connection',
                message: 'You are currently offline. Some features may be unavailable.',
                meta: 'Please check your network.'
            });
        });

        window.addEventListener('online', () => {
            showToast({
                type: 'success',
                title: 'Connection Restored',
                message: 'You are back online. Refreshing data...',
                meta: 'Welcome back!'
            });
            fetchData(); // Refresh data once connection is back
        });


        // ...existing code...
    </script>

</body>

</html>

</html>