<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Data Viewer</title>
    <style>
        /* ===========================
           Modern Glass-Morphism Theme
           Accent: teal -> sky-blue gradient
           Animated soft background gradient
           =========================== */

        :root {
            --accent-1: #00bcd4;
            --accent-2: #2196f3;
            --panel-bg: rgba(255, 255, 255, 0.62);
            --panel-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 10px 30px rgba(14, 22, 33, 0.08);
            --muted: #64748b;
            --text: #0f1724;
            --radius: 14px;
            --transition: 220ms cubic-bezier(.2, .9, .3, 1);
            --table-head: linear-gradient(90deg, rgba(0, 188, 212, 0.95), rgba(33, 150, 243, 0.95));
            --row-hover: #f0f2f5;
            --glass-blur: 10px;
            --max-width: 1800px;
            --font-sans: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        /* Background animated gradient */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(120deg, #e6f7fb 0%, #f6fbff 30%, #eef9ff 60%, #f2fbff 100%);
            overflow-y: auto;
        }

        /* Subtle animated overlay to add depth (non-distracting) */
        body::before {
            content: "";
            position: fixed;
            inset: -20%;
            z-index: -1;
            background: conic-gradient(from 200deg at 50% 50%, rgba(0, 188, 212, 0.12), rgba(33, 150, 243, 0.08), rgba(0, 188, 212, 0.12));
            filter: blur(80px) saturate(120%);
            animation: floatBG 18s linear infinite;
            opacity: 0.95;
        }

        @keyframes floatBG {
            0% {
                transform: rotate(0deg) scale(1);
            }

            50% {
                transform: rotate(12deg) scale(1.06);
            }

            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        /* Main container */
        .wrapper {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 48px 20px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: var(--max-width);
            background: var(--panel-bg);
            border-radius: calc(var(--radius) + 6px);
            padding: 22px;
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--panel-border);
            box-shadow: var(--glass-shadow);
            transition: transform var(--transition), box-shadow var(--transition);
        }

        .container:hover {
            transform: translateY(-4px);
            box-shadow: 0 22px 50px rgba(14, 22, 33, 0.12);
        }

        /* New styles for the title in the action bar */
        .table-actions .title {
            display: flex;
            flex-direction: column;
            margin-right: 24px;
            /* Add space between title and search bar */
        }

        .table-actions .title h1 {
            font-size: 18px;
            /* Match font size from view_assets */
            font-weight: 700;
            color: var(--accent-2);
            /* Use the theme's blue accent color */
            margin: 0;
        }

        .table-actions .title p {
            font-size: 12px;
            /* Match font size from view_assets */
            color: var(--muted);
            font-weight: 500;
            margin: 4px 0 0 0;
        }

        header .title {
            display: flex;
            flex-direction: column;
        }

        header h1 {
            font-size: 22px;
            margin: 0;
            color: var(--text);
            font-weight: 700;
            letter-spacing: -0.2px;
        }

        header p {
            margin: 4px 0 0 0;
            font-size: 13px;
            color: var(--muted);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        body {
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-direction: column;
            align-items: flex-end;
        }

        #welcomeMessage {
            font-weight: 600;
            color: var(--text);
        }

        /* Buttons */
        .btn {
            appearance: none;
            border: none;
            padding: 10px 16px;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            transition: transform var(--transition), box-shadow var(--transition), opacity var(--transition);
            display: inline-flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .action-btn {
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
            color: #fff;
            box-shadow: 0 8px 18px rgba(3, 169, 244, 0.14);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 14px 40px rgba(3, 169, 244, 0.18);
        }

        #logoutButton {
            background: transparent;
            color: var(--accent-2);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(33, 150, 243, 0.14);
            font-weight: 700;
        }

        #logoutButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(33, 150, 243, 0.06);
        }

        /* Table area */
        .table-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: flex-start;
            /* Align items to the start */
            margin: 8px 0 16px 0;
            flex-wrap: wrap;
        }

        #searchBar {
            width: 420px;
            max-width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 36, 0.06);
            background: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            box-shadow: 0 6px 18px rgba(12, 18, 30, 0.03);
            transition: box-shadow var(--transition), border-color var(--transition);
        }

        /* Push the submit button to the far right */
        .table-actions .action-btn {
            margin-left: auto;
        }

        #searchBar:focus {
            outline: none;
            border-color: rgba(0, 188, 212, 0.6);
            box-shadow: 0 12px 30px rgba(0, 188, 212, 0.08);
            background: #fff;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(15, 23, 36, 0.04);
            padding: 6px;
            box-shadow: 0 10px 36px rgba(12, 18, 30, 0.04);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 920px;
            table-layout: fixed;
            font-size: 14px;
        }

        thead th {
            color: #fff;
            padding: 12px 14px;
            text-align: left;
            font-weight: 700;
            background: var(--table-head);
            background-clip: padding-box;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            position: sticky;
            top: 0;
            z-index: 3;
        }

        th,
        td {
            padding: 14px 12px;
            vertical-align: top;
            border-bottom: 1px solid rgba(15, 23, 36, 0.04);
            color: var(--text);
            word-wrap: break-word;
        }

        tbody tr {
            transition: background var(--transition);
        }

        /* Column widths tuned for readability (kept same columns) */
        #ticketsTable th:nth-child(1) {
            width: 8%;
        }

        #ticketsTable th:nth-child(2) {
            width: 9%;
        }

        #ticketsTable th:nth-child(3) {
            width: 10%;
        }

        #ticketsTable th:nth-child(4) {
            width: 10%;
        }

        #ticketsTable th:nth-child(5) {
            width: 17%;
        }

        #ticketsTable th:nth-child(6) {
            width: 10%;
        }

        #ticketsTable th:nth-child(7) {
            width: 8%;
        }

        #ticketsTable th:nth-child(8) {
            width: 13%;
        }

        #loadingMessage {
            padding: 26px;
            text-align: center;
            color: var(--muted);
            font-weight: 600;
        }

        /* Login modal (glass) */
        .action-btn {
            padding: 10px 18px;
            border-radius: 10px;
        }

        .status-open {
            color: #ef4444;
            font-weight: bold;
        }

        .status-closed {
            color: #22c55e;
            font-weight: bold;
        }

        .login-image-container {
            flex-basis: 45%;
            min-height: 280px;
            background-image: linear-gradient(180deg, rgba(0, 188, 212, 0.08), rgba(33, 150, 243, 0.05)), url('https://i.imgur.com/1sOjAqv.png');
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
        }

        .login-form-wrapper {
            flex-basis: 60%;
            /* Gave more space to the form */
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .login-card h2 {
            margin: 0;
            font-size: 20px;
            color: var(--accent-2);
            font-weight: 800;
        }

        .form-container {
            position: relative;
        }

        form {
            width: 100%;
        }

        .input-group {
            position: relative;
            margin-bottom: 14px;
        }

        .input-group .icon {
            position: absolute;
            top: 50%;
            left: 14px;
            transform: translateY(-50%);
            ;
            color: #6b7280;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            /* Reduced padding */
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 36, 0.06);
            background: rgba(255, 255, 255, 0.95);
            font-size: 13px;
            /* Smaller font */
            transition: box-shadow var(--transition), border-color var(--transition);
            box-sizing: border-box;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 8px 24px rgba(77, 163, 255, 0.08);
            background: #fff;
        }

        .form-container button[type="submit"] {
            width: 100%;
            padding: 10px;
            /* Reduced padding */
            border-radius: 10px;
            font-size: 14px;
            /* Smaller font */
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            background: linear-gradient(90deg, rgba(0, 188, 212, 0.14), rgba(33, 150, 243, 0.14));
            color: var(--accent-2);
            border: 1px solid rgba(33, 150, 243, 0.14);
            transition: all var(--transition);
        }

        .form-container button[type="submit"]:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(3, 169, 244, 0.08);
        }

        .error {
            color: #d04545;
            font-weight: 600;
            min-height: 20px;
            margin-top: 6px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 980px) {
            c .login-image-container {
                display: none;
            }

            .login-card {
                max-width: 92%;
            }
        }

        /* --- Copied Modal & Form Styles from Ticket Home Page.html --- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.6);
            align-items: flex-start;
            /* Align to top */
            justify-content: center;
            padding-top: 5vh;
            /* Add some space from the top */
        }

        .modal.show {
            display: flex
        }

        .modal-content {
            width: 70%;
            max-width: 720px;
            margin: 0 auto;
            border-radius: 12px;
            max-height: 92vh;
            overflow-y: auto;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(255, 255, 255, 0.92));
            color: #063046;
            padding: 22px;
            box-shadow: 0 26px 60px rgba(7, 18, 30, 0.12);
            border: 1px solid rgba(15, 23, 36, 0.04);
            position: relative;
            animation: modalFade .32s ease;
        }


        @keyframes modalFade {
            from {
                transform: translateY(-8px);
                opacity: 0
            }

            to {
                transform: none;
                opacity: 1
            }
        }

        .generating-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            color: #111;
            text-align: center;
            padding: 18px;
        }

        .generating-overlay .spinner {
            width: 40px;
            height: 40px;
            border: 5px solid rgba(100, 116, 139, 0.28);
            border-top-color: var(--accent-1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 18px
        }

        .modal-header h2 {
            font-size: 20px;
            margin: 6px 0 0 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px 12px;
        }

        .modal-content label {
            display: block;
            margin-bottom: 6px;
            color: var(--muted);
            font-weight: 700;
        }

        /* Style inputs for the new modal to be readable */
        #requestModal input[type="text"],
        #requestModal input[type="file"],
        #requestModal select,
        #requestModal textarea {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 36, 0.06);
            background: #fff;
            color: #111;
            transition: box-shadow var(--transition), border var(--transition);
        }

        #requestModal input:focus,
        #requestModal select:focus,
        #requestModal textarea:focus {
            box-shadow: 0 0 8px rgba(37, 99, 235, 0.12);
            border-color: var(--accent-hover);
            outline: none
        }

        /* --- New Floating Label Styles --- */
        .form-grid .full {
            grid-column: 1 / -1;
        }

        .field {
            position: relative;
        }

        .field .input,
        #requestModal textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(15, 23, 36, 0.06);
            background: #fff !important;
            color: #000 !important;
            font-size: 14px;
            box-sizing: border-box;
        }

        #requestModal textarea {
            padding-top: 24px;
            min-height: 110px;
        }

        .field .label {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            color: #6b7280;
            transition: all 160ms cubic-bezier(.2, .9, .2, 1);
            pointer-events: none;
            background: transparent;
            padding: 0 6px;
        }

        .field .input:focus+.label,
        .field .input:not(:placeholder-shown)+.label,
        .field textarea:focus+.label,
        .field textarea:not(:placeholder-shown)+.label {
            transform: translateY(-155%);
            font-size: 12px;
            color: var(--brand);
            opacity: 1;
        }

        /* Fix: Position the textarea label at the top, not the center */
        .field textarea+.label {
            top: 16px;
            transform: translateY(0);
        }


        #requestModal textarea {
            min-height: 110px;
            resize: vertical
        }

        .error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.08) !important
        }

        .submit-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .submit-btn {
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
            color: #fff;
            font-weight: 800;
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 10px 32px rgba(3, 169, 244, 0.12);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        /* Success Modal */
        .success-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(6, 20, 30, 0.36);
            align-items: flex-start;
            /* Align to top */
            justify-content: center;
            padding-top: 5vh;
            /* Add some space from the top */
            z-index: 10020
        }

        .success-content {
            width: 90%;
            max-width: 420px;
            border-radius: 12px;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: #fff;
            text-align: center;
            box-shadow: 0 20px 48px rgba(3, 169, 244, 0.18);
            animation: slideDown 0.36s ease;
        }

        .success-content p {
            margin: 10px 0 14px;
            font-weight: 700;
            font-size: 18px
        }

        /* Spinner Overlay */
        .spinner-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(6, 20, 30, 0.45);
            z-index: 10030;
            align-items: center;
            justify-content: center;
            transition: opacity 0.22s ease;
        }

        .spinner-overlay.show {
            display: flex;
            opacity: 1
        }

        /* --- Copied Close Button Style --- */
        .close {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 26px;
            font-weight: 700;
            color: #9ca3af;
            cursor: pointer;
            transition: color 140ms ease;
        }

        .close:hover {
            color: #374151;
        }

        /* Side Notification */
        .side-notification {
            position: fixed;
            top: 88px;
            left: -420px;
            min-width: 320px;
            max-width: 380px;
            background: white;
            padding: 14px 18px;
            border-radius: 0 8px 8px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.12);
            transition: left .45s cubic-bezier(.25, .46, .45, .94);
            z-index: 1400;
            border-left: 5px solid #28a745;
            color: #111;
            /* Ensure text is dark */
        }

        .side-notification.show {
            left: 0;
        }

        /* Responsive */
        @media (max-width: 980px) {
            .login-image-container {
                display: none;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header-user {
                align-items: flex-start;
            }

            thead th {
                font-size: 13px;
            }

            th,
            td {
                padding: 12px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 520px) {
            .container {
                padding: 16px;
            }

            #searchBar {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="container">
            <div id="mainContainer">
                <div class="table-actions">
                    <div class="title">
                        <h1>IT Ticket System Data</h1>
                        <p>Live data fetched from Google Sheets.</p>
                    </div>
                    <input type="text" id="searchBar" placeholder="üîç Search tickets..." />
                    <button class="action-btn btn" onclick="openRequestModal()">üìù Submit Ticket</button>
                </div>

                <div class="table-container">
                    <table id="ticketsTable">
                        <thead>
                            <tr>
                                <th>Date Submitted</th>
                                <th>Ticket Number</th>
                                <th>Asset Code</th>
                                <th>Branch / Reported By</th>
                                <th>Issue Details</th>
                                <th>IT Personnel</th>
                                <th>Repair Completion</th>
                                <th>Repair Details</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsTbody">
                            <!-- Data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                    <div id="loadingMessage">
                        <p>Loading ticket data, please wait...</p>
                    </div>
                </div>
            </div>

            <!-- Copied Modals from Ticket Home Page.html -->
            <div id="requestModal" class="modal">
                <div class="modal-content">
                    <div class="generating-overlay">
                        <div class="spinner"></div>
                        <p>Please wait while ticket number is being generated...</p>
                    </div>
                    <span class="close" onclick="closeRequestModal()">&times;</span>
                    <header class="modal-header">
                        <img src="https://imgur.com/ykZQl3d.png" alt="YTO Logo"
                            style="height: 70px; margin-bottom: 10px;" />
                        <h2>üìù Submit New Ticket</h2>
                    </header>
                    <form id="ticketForm" autocomplete="off">
                        <div class="form-grid">
                            <div class="field">
                                <input type="text" id="ticketNumber" name="ticketNumber" class="input" readonly
                                    style="color: red; font-weight: bold;" />
                                <label class="label">Ticket Number (Auto-generated)</label>
                            </div>
                            <div class="field">
                                <input type="text" id="assetCode" name="assetCode" class="input" placeholder=" "
                                    list="assetCodeList" />
                                <label for="assetCode" class="label">Asset Code</label>
                                <datalist id="assetCodeList"></datalist>
                            </div>
                            <div class="field">
                                <select id="regionSelect" name="region" class="input" required
                                    onchange="onRegionChange()">
                                    <option value="">-- Select Region --</option>
                                    <option>Batangas Operation</option>
                                    <option>Laguna Operation</option>
                                    <option>Cavite Operation</option>
                                    <option>CARMONA Operation</option>
                                    <option>Manila Operation</option>
                                    <option>Bulacan Operation</option>
                                    <option>NCR North Operation</option>
                                    <option>NCR South Operation</option>
                                    <option>Quezon City Operation</option>
                                    <option>CAMANA Operation</option>
                                    <option>Pampanga Operation</option>
                                </select>
                                <label for="regionSelect" class="label">Region</label>
                            </div>
                            <div class="field">
                                <select id="branchSelect" name="branch" class="input" required>
                                    <option value="">-- Select Branch --</option>
                                </select>
                                <label for="branchSelect" class="label">Branch</label>
                            </div>
                            <div class="field">
                                <input type="text" id="reportBy" name="reportBy" class="input" required
                                    placeholder=" " />
                                <label class="label">Reported By</label>
                            </div>
                            <div class="field">
                                <select id="deviceType" name="deviceType" class="input" required
                                    onchange="onDeviceTypeChange()">
                                    <option value="">-- Select Device --</option>
                                </select>
                                <label class="label">Device Type</label>
                            </div>
                            <div id="deviceNameContainer" style="display:none" class="full field">
                                <input type="text" id="deviceName" name="deviceName" class="input" placeholder=" " />
                                <label class="label">Please specify device name</label>
                            </div>
                            <div class="full field">
                                <textarea id="problemDescription" name="problemDescription" required
                                    placeholder=" "></textarea>
                                <label class="label">Problem Description</label>
                            </div>
                            <div class="full field">
                                <input id="photoProof" type="file" name="photoProof" class="input" accept="image/*" />
                                <label class="label"
                                    style="transform: translateY(-165%); font-size: 12px; color: var(--accent-2); opacity: 1;">Photo
                                    Proof (optional)</label>
                            </div>
                        </div>
                        <div class="submit-row">
                            <button type="submit" class="submit-btn">Submit Ticket</button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="successModal" class="success-modal" aria-hidden="true">
                <div class="success-content" role="dialog" aria-modal="true" aria-labelledby="successTitle">
                    <h2 id="successTitle">‚úÖ Ticket Submitted!</h2>
                    <p style="opacity:0.95; text-align:center;">Please take note of your Ticket Number</p>
                    <p id="modalTicket"
                        style="font-size:25px; font-weight:800; margin-top:8px; color: #ff5252; text-align:center;"></p>
                    <p id="modalDate" style="font-size:13px; opacity:0.9; margin-top:6px; text-align:center;"></p>
                    <div style="display:flex; gap:10px; margin-top:14px; justify-content:center;">
                        <button onclick="copyTicketNumber()"
                            style="padding:10px 12px; border-radius:8px; border:none; background:rgba(255,255,255,0.12); color:#fff; cursor:pointer">üìã
                            Copy Ticket Number</button>
                        <button onclick="closeSuccessModal()"
                            style="padding:10px 12px; border-radius:8px; border:none; background:#fff; color:var(--accent-2); font-weight:700; cursor:pointer">OK</button>
                    </div>
                </div>
            </div>

            <div id="spinnerOverlay" class="spinner-overlay" aria-hidden="true">
                <div class="spinner-box">
                    <div class="spinner" aria-hidden="true"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LOGIN_API_URL = "https://script.google.com/macros/s/AKfycbywN8XyFh7d7ph9bAv35V47CX6EOJK7eHg_w8-5R4Pz2MwBDmbXq43mTUb0gtcTiDr0/exec";
        const TICKETS_API_URL = "https://script.google.com/macros/s/AKfycbwTiDXSQ9sHFnsNGZudsFVH3bKqGeAOHTSCQpfqGXT-FYp2zmYCcS0xYW3zJmmsgAg/exec";
        const USERS_API_URL = "https://script.google.com/macros/s/AKfycbwTiDXSQ9sHFnsNGZudsFVH3bKqGeAOHTSCQpfqGXT-FYp2zmYCcS0xYW3zJmmsgAg/exec";
        const ASSET_API_URL = "https://script.google.com/macros/s/AKfycbywN8XyFh7d7ph9bAv35V47CX6EOJK7eHg_w8-5R4Pz2MwBDmbXq43mTUb0gtcTiDr0/exec";

        // --- Login Modal Logic ---
        let autoFetchInterval = null; // To hold the interval timer
        let isFirstLoad = true; // To track the initial data load
        let allTickets = []; // Store all tickets globally
        let assetDetailsMap = new Map(); // Store asset details for tooltips

        const mainContainer = document.getElementById("mainContainer");

        // --- New Modal Logic ---
        const requestModal = document.getElementById('requestModal');
        const successModal = document.getElementById('successModal');
        const spinnerOverlay = document.getElementById('spinnerOverlay');
        let existingTicketNumbers = new Set();
        let deviceTypeList = [];

        function finishLogin(branchName) {
            // The welcome message is now handled by the parent homepage.

            // Explicitly clear table, hide it, and show loading message on new login
            document.getElementById('ticketsTbody').innerHTML = '';
            document.getElementById('ticketsTable').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';

            isFirstLoad = true; // Reset for the new session

            // Start auto-fetching data every 3 seconds
            if (autoFetchInterval) clearInterval(autoFetchInterval);
            autoFetchInterval = setInterval(() => fetchAndDisplayTickets(branchName), 3000);

            fetchAndDisplayTickets(branchName);
            fetchAllAssetDetails(); // Fetch asset details for tooltips
        }

        /**
         * Fetches all asset details and stores them in a map for quick lookup.
         */
        async function fetchAllAssetDetails() {
            try {
                const response = await fetch(ASSET_API_URL + "?action=getAssets");
                const assets = await response.json();
                assets.forEach(asset => assetDetailsMap.set(asset[1], { type: asset[5], model: asset[7], specs: asset[8] }));
            } catch (error) {
                console.error("Failed to fetch asset details for tooltips:", error);
            }
        }

        /**
         * Fetches ticket data from the Google Apps Script endpoint and populates the table.
         * @param {string} branch - The branch to filter tickets by.
         */
        async function fetchAndDisplayTickets(branch) {
            const tbody = document.getElementById('ticketsTbody');
            const loadingMessage = document.getElementById('loadingMessage');
            const table = document.getElementById('ticketsTable');

            // On first load, show the loading message. On subsequent fetches, don't.
            if (isFirstLoad) {
                loadingMessage.style.display = 'block';
            }

            try {
                const response = await fetch(TICKETS_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                allTickets = await response.json(); // Update the global variable

                // Construct the full branch name, handling the "Batangas DC" special case
                let fullBranchName;
                const trimmedBranch = branch.trim();
                if (trimmedBranch.toLowerCase() === 'san juan') {
                    fullBranchName = 'San Juan Batangas Branch';
                } else if (trimmedBranch.toLowerCase() === 'san jose') {
                    fullBranchName = 'San Jose Batangas Branch';
                } else if (trimmedBranch === 'Batangas DC' || trimmedBranch === 'Batangas Head Office') {
                    // For these specific branches, use the name as-is
                    fullBranchName = trimmedBranch;
                } else {
                    // For all other branches, append " Branch"
                    fullBranchName = `${trimmedBranch} Branch`;
                }
                // Filter tickets by the logged-in branch
                const branchTickets = allTickets.filter(ticket => {
                    // Case-insensitive and trim whitespace for robust matching
                    // Compare against the correctly constructed full branch name
                    return (ticket.colD || '').trim().toLowerCase() === fullBranchName.trim().toLowerCase();
                });

                // Hide loading message and show table header
                if (isFirstLoad) {
                    loadingMessage.style.display = 'none';
                    isFirstLoad = false;
                }
                table.style.display = 'table';

                // Sort tickets by submission date, newest first
                branchTickets.sort((a, b) => new Date(b.colB) - new Date(a.colB));

                // --- Smart Table Update (No Blinking) ---
                const existingRows = new Map();
                tbody.querySelectorAll('tr').forEach(row => {
                    existingRows.set(row.dataset.ticketId, row);
                });

                const incomingTicketIds = new Set();

                branchTickets.forEach((ticket, index) => {
                    const ticketId = ticket.colA;
                    incomingTicketIds.add(ticketId);

                    // Generate the HTML content for the row
                    const repairStatus = (ticket.colL || 'N/A').toLowerCase();
                    const statusClass = repairStatus === 'completed' ? 'status-closed' : 'status-open'; // Using closed for 'completed' and open for others

                    const assetCode = ticket.colQ || '';
                    const assetDetails = assetDetailsMap.get(assetCode);
                    let tooltipText = assetCode;
                    if (assetDetails) {
                        // Pad labels to align the colons for better readability
                        const typeLabel = "Type: ".padEnd(8);
                        const modelLabel = "Model:".padEnd(8);
                        const specsLabel = "Specs:".padEnd(8);

                        tooltipText = `${typeLabel}${assetDetails.type}\n${modelLabel}${assetDetails.model}\n${specsLabel}${assetDetails.specs}`;
                    }

                    const rowContent = `
                        <td>${ticket.colB ?
                            `${new Date(ticket.colB).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                             <br>
                             <small style="color: #555;">${new Date(ticket.colB).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</small>`
                            : ''
                        }</td>
                        <td class="copyable-cell" title="Double-click to copy">${ticket.colA || ''}</td>
                        <td title="${tooltipText}">${assetCode}</td>
                        <td><strong>${ticket.colD || ''}</strong><br><small style="color: #555;">${ticket.colE || ''}</small></td>
                        <td><strong>${ticket.colF || ''}</strong><br><small style="color: #555;">${ticket.colG || ''}</small></td>
                        <td>${ticket.colJ || ''}${ticket.colK ?
                            `<br><small style="color: #555;">${new Date(ticket.colK).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} 
                            ${new Date(ticket.colK).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</small>`
                            : ''
                        }</td>
                        <td>${ticket.colM ?
                            `${new Date(ticket.colM).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                             <br><small style="color: #555;">${new Date(ticket.colM).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</small>`
                            : ''
                        }</td>
                        <td class="${statusClass}">${ticket.colL || ''}${ticket.colP ? `<br><small style="color: #555;">${ticket.colP}</small>` : ''}</td>
                    `;

                    if (existingRows.has(ticketId)) {
                        // Row exists, check if it needs an update
                        const row = existingRows.get(ticketId);
                        if (row.innerHTML.trim() !== rowContent.trim()) {
                            row.innerHTML = rowContent; // Update only if content changed
                            addCopyListener(row);
                        }
                    } else {
                        // New row, create and insert it
                        const newRow = document.createElement('tr');
                        newRow.dataset.ticketId = ticketId;
                        newRow.innerHTML = rowContent;
                        addCopyListener(newRow);
                        // Insert at the correct sorted position
                        const nextRow = tbody.children[index];
                        tbody.insertBefore(newRow, nextRow);
                    }
                });

                // Remove rows that are no longer in the filtered data
                existingRows.forEach((row, ticketId) => {
                    if (!incomingTicketIds.has(ticketId)) {
                        row.remove();
                    }
                });

            } catch (error) {
                console.error("Failed to fetch ticket data:", error);
                loadingMessage.innerHTML = `<p style="color: red;">Error loading data: ${error.message}. Please try refreshing the page.</p>`;
            }
        }

        /**
         * Adds a double-click event listener to the ticket number cell of a row.
         * @param {HTMLTableRowElement} rowElement The table row element.
         */
        function addCopyListener(rowElement) {
            const cell = rowElement.querySelector('.copyable-cell');
            if (cell) {
                cell.addEventListener('dblclick', () => {
                    const textToCopy = cell.textContent.trim();
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showSideNotification("Copied!", `Ticket Number <strong>${textToCopy}</strong> copied to clipboard.`);
                    }).catch(err => console.error('Failed to copy text: ', err));
                });
            }
        }

        // --- Copied JS for New Modals ---

        function openRequestModal() {
            const loggedInBranch = sessionStorage.getItem("loggedInBranch");
            if (!loggedInBranch) {
                alert("Could not identify your branch. Please log in again.");
                return;
            }

            requestModal.classList.add('show');
            requestModal.setAttribute('aria-hidden', 'false');

            // Instantly generate ticket number without waiting for the server
            generateTicketNumber();


            // Auto-fill Region and Branch based on the logged-in user
            const fullBranchName = loggedInBranch.trim() === 'Batangas DC' ? loggedInBranch : `${loggedInBranch} Branch`;
            for (const region in regionBranches) {
                if (regionBranches[region].includes(fullBranchName)) {
                    const regionSelect = document.getElementById('regionSelect');
                    const branchSelect = document.getElementById('branchSelect');

                    regionSelect.value = region;
                    onRegionChange(); // Populate branches for the selected region
                    branchSelect.value = fullBranchName;

                    // Disable the fields to prevent changes
                    regionSelect.disabled = true;
                    branchSelect.disabled = true;
                    break; // Exit loop once the branch is found
                }
            }

            fetchDeviceTypes();
            fetchAssetCodes(); // Fetch asset codes when modal opens
        }

        function closeRequestModal() {
            requestModal.classList.remove('show');
            requestModal.setAttribute('aria-hidden', 'true');
            const form = document.getElementById("ticketForm");
            if (form) form.reset();
            const branchSelect = document.getElementById("branchSelect");
            if (branchSelect) branchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
            const deviceNameContainer = document.getElementById("deviceNameContainer");
            if (deviceNameContainer) deviceNameContainer.style.display = "none";

            // Re-enable dropdowns for the next time the modal is opened
            const regionSelect = document.getElementById('regionSelect');
            if (regionSelect) regionSelect.disabled = false;
            if (branchSelect) branchSelect.disabled = false;

            generateTicketNumber();
        }

        function closeSuccessModal() {
            successModal.style.display = 'none';
            successModal.setAttribute('aria-hidden', 'true');
        }

        const regionBranches = {
            "Batangas Operation": ["Balayan Branch", "Batangas 1 Branch", "Batangas 2 Branch", "Bauan Branch", "Lemery Branch", "Lipa 1 Branch", "Lipa 2 Branch", "Malvar Branch", "Nasugbu Branch", "Rosario Branch", "San Jose Batangas Branch", "San Juan Batangas Branch", "Sto Tomas Branch", "Talisay Branch", "Batangas DC", "Batangas Head Office"],
            "Laguna Operation": ["Bay Branch", "Cabuyao Branch", "Calamba 01 Branch", "Calamba 02 Branch", "Famy Branch", "Liliw Branch", "San Pablo Branch", "San Pedro Branch", "Sta Cruz Branch", "Sta Rosa Branch", "Victoria Branch", "Laguna DC", "Laguna Head Office"],
            "Cavite Operation": ["Alfonso Branch", "Bacoor 1 Branch", "Bacoor 2 Branch", "General Trias Branch", "Imus Branch", "Indang Branch", "Kawit Branch", "Naic Branch", "Silang Branch", "Tagaytay Branch", "Tanza Branch", "Trece Martires Branch", "Dasma 001 Branch", "Dasma 002 Branch", "Cavite Head Office"],
            "CARMONA Operation": ["Cavite DC", "Carmona Branch"],
            "Manila Operation": ["Tondo Branch", "Manila Branch", "Sta. Mesa Branch", "Pandacan Branch", "Tayuman Branch", "Malate Branch"],
            "Bulacan Operation": ["Marilao Pick-Up Branch", "Marilao Delivery Branch", "Calumpit Branch", "Meycauayan Branch", "Bocaue Branch", "Santa Maria 1 Branch-San Vicente", "Santa Maria 2 Branch- Balasing", "Malolos Branch", "Paombong Branch", "Guiguinto Branch", "Pandi Branch", "Norzagaray Branch", "Plaridel Branch", "Baliuag Branch", "Valenzuela 01 Branch", "Valenzuela 02 Branch", "San Ildefonso Branch", "San Rafael Branch", "San Jose Del Monte 2", "Pulilan SC"],
            "NCR North Operation": ["Angono 001 Branch", "Antipolo 001 Branch", "Antipolo 002 Branch", "Binangonan 001 Branch", "Cainta 001 Branch", "Rodriguez 001 Branch", "San Mateo 001 Branch", "Marikina Branch"],
            "NCR South Operation": ["Makati 001 Branch", "Taguig 001 Branch", "San Juan 001 Branch", "Pasig 001 Branch", "Las Pi√±as 001 Branch", "Mandaluyong 001 Branch", "Pasig 002 Branch", "Muntinlupa 001 Branch", "Pasay 001 Branch", "Para√±aque 001 Branch", "Pateros 001 Branch", "Para√±aque 002 Branch", "Muntinlupa 002 Branch", "Las Pi√±as 002 Branch", "Makati 002 Branch", "Pasig 003 Branch", "Pasay 002 Branch"],
            "Quezon City Operation": ["Quezon City 001 Branch", "Quezon City 002 Branch", "Quezon City 003 Branch", "Quezon City 004 Branch", "Quezon City 005 Branch", "Quezon City 006 Branch", "Quezon City 007 Branch", "Quezon City 008 Branch", "Quezon City 009 Branch", "Quezon City 010 Branch"],
            "CAMANA Operation": ["North Caloocan 001 Branch", "Navotas 001 Branch", "North Caloocan 002 Branch", "South Caloocan 001 Branch", "Malabon 001 Branch", "South Caloocan 002 Branch"],
            "Pampanga Operation": ["Lubao Branch", "Angeles City 001 Branch", "Angeles City 002 Branch", "Arayat Branch", "Bacolor Branch", "San Simon Branch", "Mabalacat Branch", "Apalit Branch", "Mexico Branch", "San Fernando Branch"]
        };

        function onRegionChange() {
            const region = document.getElementById('regionSelect').value;
            const branchSelect = document.getElementById('branchSelect');
            branchSelect.innerHTML = '<option value="">-- Select Branch --</option>';
            if (regionBranches[region]) {
                regionBranches[region].forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b; opt.textContent = b;
                    branchSelect.appendChild(opt);
                });
            }
        }

        function onDeviceTypeChange() {
            const v = document.getElementById('deviceType').value || '';
            document.getElementById('deviceNameContainer').style.display = v.startsWith('Others') ? 'block' : 'none';
        }

        async function fetchExistingTickets() {
            try {
                const res = await fetch(TICKETS_API_URL);
                const tickets = await res.json();
                existingTicketNumbers = new Set(tickets.map(t => t.colA));
            } catch (error) {
                console.error("Could not fetch existing tickets:", error);
            }
        }

        function generateTicketNumber() {
            // Generate a random number instantly. The backend should handle any rare uniqueness checks.
            const num = 'IT-Repair-' + String(Math.floor(Math.random() * 99999 + 1)).padStart(5, '0');
            document.getElementById('ticketNumber').value = num;
        }

        async function fetchDeviceTypes() {
            if (deviceTypeList.length > 0) return;
            try {
                const url = new URL(USERS_API_URL);
                url.searchParams.set('action', 'getDeviceTypes');
                const response = await fetch(url);
                const result = await response.json();
                if (result && result.success && Array.isArray(result.data)) {
                    deviceTypeList = result.data.sort();
                    const deviceSelect = document.getElementById('deviceType');
                    deviceSelect.innerHTML = '<option value="">-- Select Device --</option>';
                    deviceTypeList.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device;
                        option.textContent = device;
                        deviceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Failed to fetch device types:", error);
            }
        }

        async function fetchAssetCodes() {
            const assetCodeList = document.getElementById('assetCodeList');
            const loggedInBranch = sessionStorage.getItem("loggedInBranch");

            if (!loggedInBranch) {
                console.error("Cannot fetch asset codes: No logged-in branch found in session.");
                assetCodeList.innerHTML = ''; // Clear any old data
                return;
            } s

            // Construct the sheet name from the logged-in branch, e.g., "Lipa 1" -> "Lipa 1 Branch"
            const sheetName = `${loggedInBranch} Branch`;

            // Always clear previous options to handle potential branch changes without a full page reload.
            assetCodeList.innerHTML = '';

            try {
                const url = new URL(LOGIN_API_URL);
                url.searchParams.set('action', 'getAssetCodes');
                url.searchParams.set('sheetname', sheetName);

                const response = await fetch(url);
                const result = await response.json();

                if (result && result.success && Array.isArray(result.data)) {
                    result.data.forEach(code => {
                        assetCodeList.innerHTML += `<option value="${code}"></option>`;
                    });
                }
            } catch (error) {
                console.error("Failed to fetch asset codes:", error);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = err => reject(err);
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('ticketForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // --- New Validation Logic ---
            const assetCode = document.getElementById('assetCode').value.trim();
            const problemDescription = document.getElementById('problemDescription').value.trim().toLowerCase();
            const today = new Date().toLocaleDateString();

            if (assetCode) {
                const todaysTicketsForAsset = allTickets.filter(ticket => {
                    const ticketDate = new Date(ticket.colB).toLocaleDateString();
                    return ticket.colQ === assetCode && ticketDate === today;
                });

                const hasDuplicateProblem = todaysTicketsForAsset.some(ticket =>
                    (ticket.colG || '').trim().toLowerCase() === problemDescription
                );

                if (hasDuplicateProblem) {
                    alert('A ticket for this asset with the same problem has already been submitted today. Please check the existing ticket.');
                    return; // Stop the submission
                }
            }
            // --- End of New Validation Logic ---


            const requiredFields = [
                document.getElementById('regionSelect'),
                document.getElementById('branchSelect'),
                document.getElementById('reportBy'),
                document.getElementById('deviceType'),
                document.getElementById('problemDescription')
            ];
            let ok = true;
            requiredFields.forEach(f => {
                if (!f.value || f.value.trim() === '') {
                    f.classList.add('error'); ok = false;
                } else { f.classList.remove('error') }
            });
            if (!ok) { alert('Please fill in all required fields.'); return; }

            spinnerOverlay.classList.add('show');

            const formData = new FormData();
            formData.append('ticketNumber', document.getElementById('ticketNumber').value);
            formData.append('region', document.getElementById('regionSelect').value);
            formData.append('assetCode', document.getElementById('assetCode').value);
            formData.append('branch', document.getElementById('branchSelect').value);
            formData.append('reportBy', document.getElementById('reportBy').value);
            formData.append('deviceType', document.getElementById('deviceType').value);
            const deviceName = document.getElementById('deviceName');
            if (deviceName && deviceName.value) formData.append('deviceName', deviceName.value);
            formData.append('problemDescription', document.getElementById('problemDescription').value);

            const photoInput = document.getElementById('photoProof');
            if (photoInput && photoInput.files.length > 0) {
                try {
                    const base64 = await fileToBase64(photoInput.files[0]); // data:[...],base64...
                    formData.append('photoProof', base64);
                } catch (err) {
                    console.error('File read error', err);
                }
            } else {
                formData.append('photoProof', '');
            }

            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const res = await fetch(TICKETS_API_URL, { method: 'POST', body: formData });
                const result = await res.json();
                // The Apps Script returns a JSON object with a success property
                if (result && result.success) {
                    document.getElementById('modalTicket').textContent = document.getElementById('ticketNumber').value;
                    document.getElementById('modalDate').textContent = new Date().toLocaleString();
                    successModal.style.display = 'flex';
                    successModal.setAttribute('aria-hidden', 'false');
                    closeRequestModal(); // Close and reset the form
                } else {
                    console.error('Submission response:', result);
                    alert('Error submitting ticket. Try again.');
                }
            } catch (err) {
                console.error(err);
                alert('Internet Connection error. Try again.');
            } finally {
                spinnerOverlay.classList.remove('show');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Ticket';
            }
        });

        /**
         * Shows a slide-in notification from the side of the screen.
         * @param {string} title - The title of the notification.
         * @param {string} message - The message content (can include HTML).
         */
        function showSideNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'side-notification';
            notification.innerHTML = `<h4 style="margin:0 0 5px;font-size:15px">${title}</h4><div style="font-size:13px;color:#285a8a">${message}</div>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 60);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 4200);
        }

        function copyTicketNumber() {
            const t = document.getElementById('modalTicket').textContent;
            if (!t) return;
            navigator.clipboard.writeText(t).then(() => alert('Ticket number copied!')).catch(() => alert('Failed to copy'));
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeRequestModal();
                closeSuccessModal();
            }
        });

        // Run the function when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const loggedInBranch = urlParams.get('branch');

            if (loggedInBranch) {
                sessionStorage.setItem("loggedInBranch", loggedInBranch); // Store for modals
                // If already logged in, show content and fetch data
                finishLogin(loggedInBranch);
            } else {
                document.body.innerHTML = '<div style="text-align:center; padding: 50px; font-size: 1.2em;">Please log in to view tickets.</div>';
            }

            // --- Dynamic Search Bar Logic ---
            const searchBar = document.getElementById('searchBar');
            const ticketsTbody = document.getElementById('ticketsTbody');

            searchBar.addEventListener('input', () => {
                const searchTerm = searchBar.value.toLowerCase();
                const rows = ticketsTbody.getElementsByTagName('tr');

                for (const row of rows) {
                    const rowText = row.textContent.toLowerCase();
                    if (rowText.includes(searchTerm)) {
                        row.style.display = ''; // Show row
                    } else {
                        row.style.display = 'none'; // Hide row
                    }
                }
            });
        });
    </script>

</body>

</html>